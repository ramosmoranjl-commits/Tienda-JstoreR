<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111827">
    <title>JstoreR · Tienda Oficial</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root { --bg-body: #0b0f19; --bg-card: #111827; --bg-panel: #1f2937; --accent-gold: #d4af37; --success: #10b981; --danger: #ef4444; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-body); color: #f3f4f6; min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; padding-top: 40px; }
        h1, h2, h3 { font-family: 'Cinzel', serif; color: var(--accent-gold); }
        
        /* Top Bar */
        .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 40px; background: linear-gradient(90deg, #111, #222); display: flex; align-items: center; justify-content: center; z-index: 2000; font-size: 0.8rem; border-bottom: 1px solid #d4af37; }
        
        /* Header */
        .header-main { position: sticky; top: 40px; z-index: 1000; background: rgba(17, 24, 39, 0.9); backdrop-filter: blur(10px); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .brand-logo { height: 40px; }

        /* Search & Cart */
        .search-field { background: rgba(255,255,255,0.1); border: none; color: white; padding: 10px 15px; border-radius: 20px; width: 100%; max-width: 200px; }
        .cart-trigger { position: relative; font-size: 1.2rem; color: var(--accent-gold); cursor: pointer; margin-left: 15px; }
        .cart-badge { position: absolute; top: -5px; right: -8px; background: var(--danger); color: white; font-size: 0.7rem; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Catalog Grid */
        .catalog-section { padding: 20px; flex: 1; }
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .product-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); border-radius: 15px; overflow: hidden; display: flex; flex-direction: column; }
        .product-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: #000; }
        .card-info { padding: 12px; }
        .card-title { font-size: 0.95rem; margin-bottom: 5px; color: white; }
        .card-price { color: var(--accent-gold); font-weight: 700; font-size: 1.1rem; }
        .btn-add { background: var(--accent-gold); border: none; width: 100%; padding: 8px; margin-top: 10px; border-radius: 8px; font-weight: 700; cursor: pointer; }

        /* Sidebar */
        .sidebar { position: fixed; top: 0; right: -100%; width: 100%; max-width: 400px; height: 100%; background: var(--bg-panel); z-index: 3000; transition: 0.4s; padding: 20px; display: flex; flex-direction: column; box-shadow: -10px 0 50px rgba(0,0,0,0.8); }
        .sidebar.active { right: 0; }
        
        /* Map & Form */
        #map-frame { height: 250px; width: 100%; background: #000; border-radius: 10px; margin: 15px 0; border: 1px solid #444; }
        .form-input { width: 100%; padding: 12px; margin-bottom: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 8px; }
        .btn-wa { background: #25D366; color: white; width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 700; font-size: 1rem; margin-top: auto; cursor: pointer; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 4000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--bg-panel); padding: 20px; border-radius: 15px; max-width: 400px; width: 100%; text-align: center; }
        .modal-content img { width: 100%; max-height: 300px; object-fit: contain; margin-bottom: 15px; }

        /* Error Box */
        .error-msg { color: #ef4444; background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #ef4444; margin: 20px; }
    </style>
</head>
<body>

    <div class="top-bar">🚚 ENVÍOS A TODO EL PERÚ | LIMA EXPRESS</div>

    <header class="header-main">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png" class="brand-logo">
            <span style="font-weight:700; color:var(--accent-gold); font-size:1.2rem;">JstoreR</span>
        </div>
        <div style="display:flex; align-items:center;">
            <div class="cart-trigger" onclick="app.toggleSidebar()">
                <i class="fa-solid fa-cart-shopping"></i>
                <div class="cart-badge" id="cart-count">0</div>
            </div>
        </div>
    </header>

    <main class="catalog-section">
        <div class="grid-layout" id="catalog-mount">
            <div style="grid-column:1/-1; text-align:center; padding:50px; color:gray;">
                <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--accent-gold)"></i><br><br>
                Conectando con Supabase...
            </div>
        </div>
    </main>

    <div class="sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3>Tu Pedido</h3>
            <button onclick="app.toggleSidebar()" style="background:none; border:none; color:white; font-size:1.5rem;">×</button>
        </div>
        
        <div id="cart-items" style="flex:1; overflow-y:auto; margin-bottom:20px;">
            <p style="text-align:center; color:gray;">Carrito vacío</p>
        </div>

        <div style="border-top:1px solid #444; padding-top:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>Subtotal:</span> <span id="cart-total" style="color:var(--accent-gold); font-weight:700;">S/ 0.00</span>
            </div>
            
            <h4 style="margin:15px 0 10px;">Datos de Envío</h4>
            <input type="text" id="cust-name" class="form-input" placeholder="Tu Nombre">
            <input type="text" id="cust-addr" class="form-input" placeholder="Dirección / Distrito">
            
            <div id="map-frame"></div> <p style="font-size:0.8rem; color:gray; text-align:center; margin-bottom:10px;">Mueve el pin para calcular envío</p>

            <button class="btn-wa" onclick="app.checkout()">
                <i class="fa-brands fa-whatsapp"></i> PEDIR POR WHATSAPP
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="product-modal" onclick="this.classList.remove('active')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="m-img" src="">
            <h3 id="m-title"></h3>
            <p id="m-desc" style="color:gray; margin:10px 0;"></p>
            <h2 id="m-price" style="color:var(--accent-gold);"></h2>
            <button class="btn-add" id="m-btn">AGREGAR</button>
        </div>
    </div>

    <script>
        // --- DATOS SENSIBLES ---
        const SUPABASE_URL = 'https://imzxubveghxhfgeyciet.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltenh1YnZlZ2h4aGZnZXljaWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MDI5ODIsImV4cCI6MjA4NDE3ODk4Mn0.ro9J3cUVUVQfigzsTjh71EU56rG8b2diJ-qlQQ5xvdw';
        const MAPBOX_TOKEN = "pk.eyJ1IjoianN0b3JlciIsImEiOiJjbWtoZ3o0eXowazJqM2pxMjJsZGNzanBzIn0.-7Ml_9KDQCzhGYqkiJdKzA";

        // Variables Globales
        let supabase;
        let map;
        let cart = [];
        let products = [];
        const STORE = { lat: -12.051800, lng: -77.028500 };

        const app = {
            init: async function() {
                try {
                    // 1. Verificar Supabase
                    if (typeof window.supabase === 'undefined') throw new Error("Librería Supabase no cargó");
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

                    // 2. Intentar Bajar Productos
                    const { data, error } = await supabase.from('products').select('*');

                    if (error) throw new Error("Error Supabase: " + error.message);
                    if (!data || data.length === 0) throw new Error("Conexión exitosa, pero TABLA VACÍA. Sube productos en Supabase.");

                    // 3. Renderizar
                    this.products = data;
                    this.renderCatalog(data);
                    
                    // 4. Iniciar Mapa (si no falla lo anterior)
                    this.initMap();

                } catch (e) {
                    // ERROR EN PANTALLA (Para que lo veas en el celular)
                    const msg = e.message.includes("relation") ? "Error: La tabla no se llama 'products' (revisa mayúsculas)" : e.message;
                    
                    document.getElementById('catalog-mount').innerHTML = `
                        <div class="error-msg">
                            <i class="fa-solid fa-triangle-exclamation fa-3x"></i><br><br>
                            <strong>ALGO SALIÓ MAL:</strong><br>${msg}<br><br>
                            Toma captura y muéstraselo al desarrollador.
                        </div>`;
                    alert("ERROR DETECTADO: " + msg); // Alerta nativa del celular
                }
            },

            renderCatalog: function(list) {
                const html = list.map(p => `
                    <div class="product-card" onclick="app.showModal('${p.id}')">
                        <img src="${p.image}" class="product-img">
                        <div class="card-info">
                            <div class="card-title">${p.name}</div>
                            <div class="card-price">S/ ${parseFloat(p.price).toFixed(2)}</div>
                            <button class="btn-add" onclick="event.stopPropagation(); app.add('${p.id}')">AGREGAR</button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('catalog-mount').innerHTML = html;
            },

            add: function(id) {
                const p = this.products.find(x => x.id === id);
                const item = cart.find(x => x.id === id);
                if(item) item.qty++;
                else cart.push({...p, qty:1});
                this.updateCart();
                alert("Agregado: " + p.name);
            },

            updateCart: function() {
                document.getElementById('cart-count').innerText = cart.reduce((a,b)=>a+b.qty,0);
                const total = cart.reduce((a,b)=>a+(b.price*b.qty),0);
                document.getElementById('cart-total').innerText = "S/ " + total.toFixed(2);
                
                document.getElementById('cart-items').innerHTML = cart.map(i => 
                    `<div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                        <span>${i.qty} x ${i.name}</span>
                        <span>S/ ${i.price * i.qty}</span>
                    </div>`
                ).join('');
            },

            showModal: function(id) {
                const p = this.products.find(x => x.id === id);
                document.getElementById('m-img').src = p.image;
                document.getElementById('m-title').innerText = p.name;
                document.getElementById('m-desc').innerText = p.description || "";
                document.getElementById('m-price').innerText = "S/ " + p.price;
                document.getElementById('m-btn').onclick = () => { app.add(id); document.getElementById('product-modal').classList.remove('active'); };
                document.getElementById('product-modal').classList.add('active');
            },

            toggleSidebar: function() { document.getElementById('sidebar').classList.toggle('active'); },

            initMap: function() {
                if (typeof mapboxgl === 'undefined') return;
                mapboxgl.accessToken = MAPBOX_TOKEN;
                map = new mapboxgl.Map({ container: 'map-frame', style: 'mapbox://styles/mapbox/navigation-night-v1', center: [STORE.lng, STORE.lat], zoom: 13 });
                new mapboxgl.Marker({color:'#d4af37'}).setLngLat([STORE.lng, STORE.lat]).addTo(map);
            },

            checkout: function() {
                const name = document.getElementById('cust-name').value;
                const addr = document.getElementById('cust-addr').value;
                if(!name || !addr) return alert("Ingresa tu nombre y dirección");
                
                let msg = `*NUEVO PEDIDO* 🛍️\nCliente: ${name}\nDirección: ${addr}\n\n`;
                cart.forEach(i => msg += `${i.qty} x ${i.name}\n`);
                msg += `\nTOTAL: ${document.getElementById('cart-total').innerText}`;
                window.open(`https://wa.me/51932508670?text=${encodeURIComponent(msg)}`);
            }
        };

        // Iniciar
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
