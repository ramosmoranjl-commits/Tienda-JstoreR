<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111827">
    <meta name="description" content="Tienda oficial JstoreR. Catálogo exclusivo y envíos a todo el Perú.">
    
    <title>JstoreR · Tienda Oficial</title>

    <link rel="icon" type="image/png" href="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* ==========================================================================
           1. ESTILOS GENERALES (Dark Mode Premium)
           ========================================================================== */
        :root {
            --bg-body: #0b0f19;
            --bg-card: #111827;
            --bg-panel: #1f2937;
            --bg-glass: rgba(17, 24, 39, 0.85);
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --accent-gold: #d4af37;
            --accent-gold-hover: #b4941f;
            --success: #10b981;
            --danger: #ef4444;
            --font-display: 'Cinzel', serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;
            --header-h: 80px;
            --topbar-h: 40px;
            --container: 1440px;
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-body); background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; padding-top: var(--topbar-h); }
        h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 700; color: var(--text-main); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; border: 1px solid var(--bg-body); }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-gold); }

        /* TOP BAR */
        .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: var(--topbar-h); background: linear-gradient(90deg, #111, #222); border-bottom: 1px solid rgba(212, 175, 55, 0.3); display: flex; align-items: center; justify-content: center; z-index: 2000; font-size: 0.85rem; font-weight: 600; letter-spacing: 1px; color: white; overflow: hidden; }
        .top-pulse { animation: pulseText 2s infinite; display: flex; align-items: center; gap: 10px; }
        .top-bar i { color: var(--accent-gold); }
        @keyframes pulseText { 0% { opacity: 0.8; } 50% { opacity: 1; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); } 100% { opacity: 0.8; } }

        /* HEADER */
        .header-main { position: sticky; top: var(--topbar-h); z-index: 1000; height: var(--header-h); background: var(--bg-glass); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.3s; }
        .nav-wrapper { max-width: var(--container); height: 100%; margin: 0 auto; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        .brand-box { display: flex; align-items: center; gap: 12px; text-decoration: none; }
        .brand-logo { height: 45px; width: auto; transition: transform 0.3s; filter: drop-shadow(0 0 5px rgba(212, 175, 55, 0.2)); }
        .brand-box:hover .brand-logo { transform: scale(1.05) rotate(-2deg); }
        .brand-text { font-family: var(--font-display); font-size: 1.5rem; color: var(--accent-gold); letter-spacing: 2px; }

        .search-dock { flex: 1; max-width: 500px; position: relative; }
        .search-field { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px 20px 12px 50px; border-radius: 50px; font-size: 0.95rem; transition: 0.3s; }
        .search-field:focus { border-color: var(--accent-gold); background: rgba(0,0,0,0.3); box-shadow: 0 0 20px rgba(212, 175, 55, 0.15); }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: var(--accent-gold); opacity: 0.8; }

        .cart-trigger { position: relative; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 50%; color: var(--accent-gold); cursor: pointer; transition: 0.3s; background: rgba(212, 175, 55, 0.05); }
        .cart-trigger:hover { background: var(--accent-gold); color: #000; transform: scale(1.1); }
        .cart-badge { position: absolute; top: -4px; right: -4px; background: var(--danger); color: white; font-size: 0.7rem; font-weight: 800; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-body); }

        /* CATALOG */
        .filters-bar { position: sticky; top: calc(var(--topbar-h) + var(--header-h)); z-index: 900; background: rgba(11, 15, 25, 0.95); padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(5px); }
        .pills-scroll { display: flex; gap: 12px; overflow-x: auto; max-width: var(--container); margin: auto; padding: 0 24px; scrollbar-width: none; }
        .pill { padding: 8px 24px; border: 1px solid rgba(255,255,255,0.1); border-radius: 50px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; color: var(--text-muted); transition: 0.3s; font-weight: 500; }
        .pill:hover { border-color: var(--accent-gold); color: var(--accent-gold); }
        .pill.active { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); font-weight: 800; }

        .catalog-section { padding: 40px 24px; max-width: var(--container); margin: auto; min-height: 60vh; }
        .grid-layout { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }

        .product-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; transition: 0.4s; position: relative; }
        .product-card:hover { transform: translateY(-8px); border-color: rgba(212, 175, 55, 0.4); box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5); }
        .card-image-wrapper { position: relative; width: 100%; aspect-ratio: 1; background: #000; overflow: hidden; cursor: pointer; }
        .product-img { width: 100%; height: 100%; object-fit: cover; transition: 0.6s ease; }
        .product-card:hover .product-img { transform: scale(1.1); }
        .stock-badge { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); color: white; padding: 5px 12px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; z-index: 2; border: 1px solid rgba(255,255,255,0.1); }
        .card-info { padding: 20px; flex: 1; display: flex; flex-direction: column; }
        .card-category { color: var(--accent-gold); font-size: 0.7rem; text-transform: uppercase; font-weight: 700; margin-bottom: 6px; letter-spacing: 1px; }
        .card-title { font-size: 1.1rem; line-height: 1.4; margin-bottom: 10px; color: white; font-weight: 700; display: block; }
        .card-desc-snippet { font-size: 0.9rem; color: #9ca3af; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; min-height: 3.6em; opacity: 0.8; }
        .card-bottom { margin-top: auto; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .card-price { font-size: 1.3rem; font-weight: 700; color: white; }
        .btn-add-cart { width: 44px; height: 44px; border-radius: 12px; background: var(--accent-gold); border: none; font-size: 1.2rem; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; color: #000; }
        .btn-add-cart:hover { transform: scale(1.1) rotate(90deg); background: white; }
        .btn-add-cart:disabled { background: #333; cursor: not-allowed; opacity: 0.5; transform: none; color: #666; }

        /* SIDEBAR & CHECKOUT */
        .sidebar { position: fixed; top: 0; right: -100%; width: 100%; max-width: 500px; height: 100%; background: var(--bg-panel); z-index: 3000; transition: 0.5s var(--ease); box-shadow: -20px 0 60px rgba(0,0,0,0.6); display: flex; flex-direction: column; }
        .sidebar.active { right: 0; }
        .sidebar-header { padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); }
        
        .shipping-progress-container { padding: 20px 24px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; font-weight: 600; }
        .progress-track { width: 100%; height: 8px; background: #374151; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #fcd34d, #d4af37); width: 0%; transition: width 0.5s ease; border-radius: 10px; }
        .progress-fill.success { background: var(--success); }

        .steps-viewport { flex: 1; position: relative; overflow: hidden; }
        .step { position: absolute; inset: 0; padding: 24px; overflow-y: auto; transition: 0.4s; display: flex; flex-direction: column; }
        #step-cart { transform: translateX(0); } #step-checkout { transform: translateX(100%); }
        .sidebar.checkout-mode #step-cart { transform: translateX(-100%); } .sidebar.checkout-mode #step-checkout { transform: translateX(0); }
        
        .cart-row { display: flex; gap: 15px; background: rgba(255,255,255,0.03); padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .qty-control { display: flex; align-items: center; gap: 12px; margin-top: 8px; background: #0b0f19; padding: 4px 10px; border-radius: 8px; width: fit-content; }
        .qty-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1rem; transition: 0.2s; }
        .qty-btn:hover { color: var(--accent-gold); }

        /* ADVANCED LOGISTICS UI */
        .logistics-box { background: #0f172a; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #1e293b; }
        
        /* Map Search Bar */
        .map-search-grid { display: flex; gap: 10px; margin-bottom: 10px; }
        .map-search-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #374151; background: #1f2937; color: white; font-size: 0.9rem; }
        .map-search-btn { padding: 0 15px; background: var(--accent-gold); color: black; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
        
        .gps-btn { width: 100%; padding: 14px; background: rgba(16, 185, 129, 0.1); color: #34d399; border: 1px dashed #34d399; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: 700; transition: 0.3s; margin-bottom: 10px; }
        .gps-btn:hover { background: rgba(16, 185, 129, 0.2); }
        
        #map-frame { height: 0; transition: 0.4s; overflow: hidden; border-radius: 10px; margin-top: 5px; opacity: 0.5; position: relative; border: 1px solid #374151; }
        #map-frame.active { height: 350px; opacity: 1; border-color: var(--accent-gold); }
        
        /* MAPBOX CUSTOM MARKERS */
        .marker-origin {
            background-image: url('https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png');
            background-size: cover;
            width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
            cursor: pointer;
        }
        .marker-dest {
            color: #d4af37;
            font-size: 30px;
            cursor: move;
            text-shadow: 0 0 10px black;
        }
        .mapboxgl-popup-content { background: var(--bg-card); color: white; border: 1px solid var(--accent-gold); border-radius: 8px; padding: 10px; font-family: var(--font-body); }
        .mapboxgl-popup-tip { border-top-color: var(--accent-gold); border-bottom-color: var(--accent-gold); }
        .mapboxgl-ctrl-bottom-right { display: none; }

        .price-summary-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-muted); }
        .price-summary-row.total { font-size: 1.2rem; color: white; font-weight: 700; border-top: 1px dashed rgba(255,255,255,0.2); padding-top: 12px; margin-top: 12px; }

        .form-input { width: 100%; padding: 16px; background: #111827; border: 1px solid #374151; color: white; border-radius: 10px; margin-bottom: 12px; font-family: inherit; font-size: 1rem; }
        .form-input:focus { border-color: var(--accent-gold); }
        .btn-final { width: 100%; padding: 18px; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; margin-top: auto; transition: 0.3s; font-size: 1.05rem; }
        .btn-next { background: var(--accent-gold); color: #000; }
        .btn-wa { background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* FAQ & MODAL */
        .faq-section { padding: 60px 24px; max-width: 1000px; margin: 0 auto; }
        .faq-header { text-align: center; margin-bottom: 40px; }
        .faq-header h2 { font-size: 2rem; color: var(--accent-gold); margin-bottom: 10px; }
        .accordion-item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 15px; overflow: hidden; }
        .accordion-header { width: 100%; padding: 20px; text-align: left; background: none; border: none; color: white; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; padding: 0 20px; color: #d1d5db; line-height: 1.6; }
        .accordion-item.active .accordion-content { padding-bottom: 20px; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 4000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--bg-panel); width: 100%; max-width: 600px; max-height: 85vh; border-radius: 20px; overflow-y: auto; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); position: relative; box-shadow: 0 50px 100px rgba(0,0,0,0.6); }
        .modal-img-box img { width: 100%; height: auto; object-fit: contain; background: #000; max-height: 350px; }
        .modal-info-box { padding: 25px; display: flex; flex-direction: column; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.5); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; z-index: 10; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .modal-desc-full { white-space: pre-wrap; color: #d1d5db; line-height: 1.6; margin: 20px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; border-left: 3px solid var(--accent-gold); max-height: 250px; overflow-y: auto; }

        .footer { background: #05080f; border-top: 1px solid rgba(255,255,255,0.05); padding: 60px 24px 30px; margin-top: auto; }
        .footer-grid { max-width: var(--container); margin: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; }
        .footer h4 { color: var(--accent-gold); margin-bottom: 20px; font-family: var(--font-display); }
        .footer ul { list-style: none; color: var(--text-muted); }
        .footer li { margin-bottom: 12px; }

        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--bg-panel); border: 1px solid var(--accent-gold); padding: 12px 30px; border-radius: 50px; color: var(--accent-gold); font-weight: 700; z-index: 5000; opacity: 0; transition: 0.3s; pointer-events: none; }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(-20px); }
        #gold-dust { position: fixed; inset: 0; pointer-events: none; z-index: 100; mix-blend-mode: screen; }
    </style>
</head>
<body>

    <canvas id="gold-dust"></canvas>
    <div id="toast"><i class="fa-solid fa-check"></i> Producto Agregado</div>
    
    <div class="top-bar">
        <span class="top-pulse"><i class="fa-solid fa-truck-fast"></i> ENVÍOS GRATIS EN PEDIDOS SUPERIORES A S/ 350.00</span>
    </div>

    <header class="header-main">
        <nav class="nav-wrapper">
            <a href="#" class="brand-box">
                <img src="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png" class="brand-logo" alt="Logo">
                <span class="brand-text">JstoreR</span>
            </a>
            <div class="search-dock"><i class="fa-solid fa-magnifying-glass search-icon"></i><input type="text" class="search-field" id="search-input" placeholder="Buscar colección..."></div>
            <div class="cart-trigger" onclick="app.toggleSidebar()"><i class="fa-solid fa-cart-shopping"></i><div class="cart-badge" id="cart-count">0</div></div>
        </nav>
    </header>

    <div class="filters-bar">
        <div class="pills-scroll" id="pills-mount"><div class="pill active">Cargando inventario...</div></div>
    </div>

    <main class="catalog-section">
        <div class="grid-layout" id="catalog-mount">
            <div style="grid-column:1/-1; text-align:center; padding:50px; color:gray;">
                <i class="fa-solid fa-circle-notch fa-spin fa-3x" style="color:var(--accent-gold)"></i><br><br>Cargando productos desde Supabase...
            </div>
        </div>
    </main>

    <section class="faq-section">
        <div class="faq-header">
            <h2>Preguntas Frecuentes</h2>
            <p>Resolvemos tus dudas antes de tu compra</p>
        </div>
        <div class="accordion">
            <div class="accordion-item">
                <button class="accordion-header" onclick="app.toggleFaq(this)">¿Hacen envíos a todo el Perú? <i class="fa-solid fa-chevron-down"></i></button>
                <div class="accordion-content"><p><br>Sí, realizamos envíos a nivel nacional. En Lima usamos motorizados express y para provincias trabajamos con Shalom y Olva Courier. Todos los envíos son 100% asegurados.</p></div>
            </div>
            <div class="accordion-item">
                <button class="accordion-header" onclick="app.toggleFaq(this)">¿Cómo obtengo el Envío Gratis? <i class="fa-solid fa-chevron-down"></i></button>
                <div class="accordion-content"><p><br>Es automático. Si tu pedido supera los <strong>S/ 350.00</strong>, el sistema descontará el costo de envío (incluso si usas el cálculo por GPS). Verás el descuento reflejado en el resumen de compra.</p></div>
            </div>
            <div class="accordion-item">
                <button class="accordion-header" onclick="app.toggleFaq(this)">¿Cuáles son los métodos de pago? <i class="fa-solid fa-chevron-down"></i></button>
                <div class="accordion-content"><p><br>Aceptamos Yape, Plin y Transferencia BCP. También aceptamos pago contra entrega (Efectivo) únicamente para distritos seleccionados de Lima Metropolitana.</p></div>
            </div>
            <div class="accordion-item">
                <button class="accordion-header" onclick="app.toggleFaq(this)">¿Tienen tienda física? <i class="fa-solid fa-chevron-down"></i></button>
                <div class="accordion-content"><p><br>Sí, nuestra oficina de distribución está en <strong>Jr. Cuzco 626, Lima</strong>. Puedes coordinar para recoger tu pedido presencialmente si lo deseas.</p></div>
            </div>
        </div>
    </section>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Tu Compra</h3>
            <button onclick="app.toggleSidebar()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">×</button>
        </div>
        
        <div class="shipping-progress-container">
            <div class="progress-label">
                <span id="shipping-msg">Falta poco para envío gratis</span>
                <span id="shipping-amt">S/ 0 / 350</span>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="shipping-bar"></div>
            </div>
        </div>

        <div class="steps-viewport">
            <div class="step" id="step-cart">
                <div id="cart-list" style="flex:1;">
                    <div style="text-align:center; margin-top:50px; color:gray; opacity:0.6;">
                        <i class="fa-solid fa-basket-shopping fa-3x"></i><br><br>Tu carrito está vacío
                    </div>
                </div>
                <div style="border-top:1px solid rgba(255,255,255,0.1); padding-top:20px; background:var(--bg-panel);">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:700; font-size:1.1rem;"><span>Subtotal</span><span id="cart-subtotal">S/ 0.00</span></div>
                    <button class="btn-final btn-next" onclick="app.goToCheckout()">Procesar Pedido</button>
                </div>
            </div>
            <div class="step" id="step-checkout">
                <button onclick="app.backToCart()" style="background:none; border:none; color:gray; margin-bottom:15px; cursor:pointer;">← Volver al carrito</button>
                <h4 style="color:var(--accent-gold); margin-bottom:10px;">Datos de Envío</h4>
                <input type="text" id="cust-name" class="form-input" placeholder="Nombre Completo">
                
                <div class="logistics-box">
                    <p style="font-size:0.8rem; color:gray; margin-bottom:10px;"><i class="fa-solid fa-store"></i> Origen: <strong>Jr. Cuzco 626, Lima</strong></p>
                    
                    <div class="map-search-grid">
                        <input type="text" id="map-search-input" class="map-search-input" placeholder="Dirección exacta (Ej: Av. San Luis 2276)">
                        <button class="map-search-btn" onclick="geo.searchAddress()"><i class="fa-solid fa-search"></i></button>
                    </div>

                    <button class="gps-btn" onclick="geo.startTracking()"><i class="fa-solid fa-location-dot"></i> Usar mi ubicación GPS</button>
                    
                    <div id="map-frame"><div id="map" style="width:100%; height:100%;"></div></div>
                    
                    <div id="shipping-info" style="display:none; margin-top:15px; border-top:1px dashed #444; padding-top:10px;">
                        <div class="price-summary-row"><span>Distancia (Ruta Aprox):</span><span id="dist-txt">0 km</span></div>
                        <div class="price-summary-row"><span>Costo Envío:</span><span id="ship-base-txt">S/ 0.00</span></div>
                        <div class="price-summary-row" id="discount-row" style="display:none; color:var(--success);"><span>Descuento Envío:</span><span>- S/ <span id="discount-val">0.00</span></span></div>
                        <div class="price-summary-row total"><span>TOTAL FINAL:</span><span id="total-txt">S/ 0.00</span></div>
                    </div>
                    
                    <input type="hidden" id="geo-lat"><input type="hidden" id="geo-lng">
                    <input type="hidden" id="calc-ship-base" value="0">
                    <input type="hidden" id="calc-ship-final" value="0">
                </div>

                <input type="text" id="cust-address" class="form-input" placeholder="Referencia adicional (Piso, Color de casa...)">
                <select id="cust-pay" class="form-input">
                    <option value="Yape/Plin">Yape / Plin</option>
                    <option value="BCP">Transferencia BCP</option>
                    <option value="Efectivo">Contra Entrega</option>
                </select>
                <button class="btn-final btn-wa" onclick="app.finalize()"><i class="fa-brands fa-whatsapp"></i> Confirmar Pedido</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="product-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="app.closeModal()">×</button>
            <div class="modal-img-box"><img id="m-img" src="" alt="Producto"></div>
            <div class="modal-info-box">
                <span id="m-cat" style="color:var(--accent-gold); font-weight:700; text-transform:uppercase;">CAT</span>
                <h2 id="m-title" style="margin:10px 0; font-size:1.5rem;">Titulo</h2>
                <h3 id="m-price" style="color:white; font-size:1.4rem;">S/ 0.00</h3>
                <div id="m-desc" class="modal-desc-full"></div>
                <button id="m-btn" class="btn-final btn-next" style="margin-top:auto;">Agregar al Carrito</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-grid">
            <div>
                <h4>JstoreR</h4>
                <p style="color:gray;">Importadores directos de tecnología y moda. Garantía asegurada.</p>
            </div>
            <div>
                <h4>Contacto</h4>
                <ul><li><i class="fa-solid fa-map-pin"></i> Jr. Cuzco 626, Lima</li><li><i class="fa-brands fa-whatsapp"></i> 932 508 670</li></ul>
            </div>
        </div>
        <div style="text-align:center; color:#444; margin-top:40px;">© 2026 JstoreR Official.</div>
    </footer>

    <script>
        // --- COPIA ESTO DESDE TU PROYECTO SUPABASE ---
        // 1. Ve a Project Settings (engranaje) -> API
        // 2. Project URL va aqui:
        const SUPABASE_URL = 'https://imzxubveghxhfgeyciet.supabase.co'; 
        
        // 3. Project API Key (anon public) va aqui:
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imltenh1YnZlZ2h4aGZnZXljaWV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MDI5ODIsImV4cCI6MjA4NDE3ODk4Mn0.ro9J3cUVUVQfigzsTjh71EU56rG8b2diJ-qlQQ5xvdwh';

        // --- CREDENCIALES MAPBOX ---
        mapboxgl.accessToken = "pk.eyJ1IjoianN0b3JlciIsImEiOiJjbWtoZ3o0eXowazJqM2pxMjJsZGNzanBzIn0.-7Ml_9KDQCzhGYqkiJdKzA";
        
        // --- INICIO DE LÓGICA ---
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const STORE_LOC = { lat: -12.051800, lng: -77.028500 };
        const FREE_SHIPPING_THRESHOLD = 350.00;

        const geo = {
            map: null, destMarker: null, LIMA_TRAFFIC_FACTOR: 1.40,

            initMap: function(centerLng, centerLat, zoom = 14) {
                const container = document.getElementById('map-frame');
                container.classList.add('active');
                if(this.map) {
                    this.map.flyTo({ center: [centerLng, centerLat], zoom: zoom, pitch: 50 });
                    return;
                }
                this.map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/navigation-night-v1',
                    center: [centerLng, centerLat],
                    zoom: zoom,
                    pitch: 45,
                    bearing: 0,
                    antialias: true
                });
                this.map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                
                const elOrigin = document.createElement('div');
                elOrigin.className = 'marker-origin';
                new mapboxgl.Marker(elOrigin)
                    .setLngLat([STORE_LOC.lng, STORE_LOC.lat])
                    .setPopup(new mapboxgl.Popup({offset: 25}).setHTML('<b>JstoreR (Origen)</b>'))
                    .addTo(this.map);

                this.map.on('click', (e) => { this.updateMarker(e.lngLat.lat, e.lngLat.lng); });
                this.map.on('load', () => {
                    this.map.resize();
                    this.map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'properties': {}, 'geometry': { 'type': 'LineString', 'coordinates': [] } } });
                    this.map.addLayer({ 'id': 'route', 'type': 'line', 'source': 'route', 'layout': { 'line-join': 'round', 'line-cap': 'round' }, 'paint': { 'line-color': '#d4af37', 'line-width': 4, 'line-dasharray': [2, 2] } });
                });
            },

            startTracking: function() {
                const btn = document.querySelector('.gps-btn');
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Obteniendo GPS...';
                if(!navigator.geolocation) { alert("GPS no soportado"); return; }
                navigator.geolocation.getCurrentPosition(pos => {
                    this.initMap(pos.coords.longitude, pos.coords.latitude, 16);
                    this.updateMarker(pos.coords.latitude, pos.coords.longitude);
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> GPS Detectado';
                }, () => { alert("Error GPS"); btn.innerHTML = 'Reintentar GPS'; }, {enableHighAccuracy:true});
            },

            searchAddress: function() {
                const query = document.getElementById('map-search-input').value;
                if(!query) return alert("Escribe una dirección");
                const btn = document.querySelector('.map-search-btn');
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
                const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${mapboxgl.accessToken}&country=pe&limit=1&types=address,poi`;
                fetch(url).then(r => r.json()).then(data => {
                    btn.innerHTML = '<i class="fa-solid fa-search"></i>';
                    if(data.features && data.features.length > 0) {
                        const [lng, lat] = data.features[0].center;
                        const foundAddr = data.features[0].place_name;
                        this.initMap(lng, lat, 17);
                        this.updateMarker(lat, lng);
                        document.getElementById('cust-address').value = foundAddr; 
                    } else { alert("No encontramos esa dirección."); }
                }).catch(() => { btn.innerHTML = '<i class="fa-solid fa-times"></i>'; alert("Error de conexión."); });
            },

            updateMarker: function(lat, lng) {
                document.getElementById('geo-lat').value = lat;
                document.getElementById('geo-lng').value = lng;
                if(this.destMarker) {
                    this.destMarker.setLngLat([lng, lat]);
                } else {
                    const elDest = document.createElement('div');
                    elDest.innerHTML = '<i class="fa-solid fa-location-dot"></i>';
                    elDest.className = 'marker-dest';
                    this.destMarker = new mapboxgl.Marker(elDest, {draggable: true})
                        .setLngLat([lng, lat])
                        .setPopup(new mapboxgl.Popup({offset: 25}).setHTML('<b>Destino</b><br>Arrástrame'))
                        .addTo(this.map);
                    this.destMarker.on('dragend', () => { const pos = this.destMarker.getLngLat(); this.updateMarker(pos.lat, pos.lng); });
                }
                if(this.map.getSource('route')) {
                    this.map.getSource('route').setData({ 'type': 'Feature', 'properties': {}, 'geometry': { 'type': 'LineString', 'coordinates': [[STORE_LOC.lng, STORE_LOC.lat], [lng, lat]] } });
                }
                const bounds = new mapboxgl.LngLatBounds(); bounds.extend([STORE_LOC.lng, STORE_LOC.lat]); bounds.extend([lng, lat]);
                this.map.fitBounds(bounds, { padding: 100, maxZoom: 16 });

                const linearDist = this.getDist(STORE_LOC.lat, STORE_LOC.lng, lat, lng);
                const realDist = linearDist * this.LIMA_TRAFFIC_FACTOR;
                let cost = realDist * 2.00;
                if (cost < 6.00) { cost = 6.00; }

                document.getElementById('shipping-info').style.display = 'block';
                document.getElementById('dist-txt').innerText = realDist.toFixed(2) + " km (Ruta aprox)";
                document.getElementById('ship-base-txt').innerText = "S/ " + cost.toFixed(2);
                document.getElementById('calc-ship-base').value = cost.toFixed(2);
                app.updateCheckoutTotals();
            },

            getDist: function(lat1, lon1, lat2, lon2) {
                const R = 6371; 
                const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }
        };

        const app = {
            data: [], cart: [], filter: 'Todos',
            
            init: async function() {
                this.initGoldDust();
                // Fetch directo a la base de datos Supabase
                const { data: dbProducts, error } = await supabase.from('products').select('*');

                if (error) {
                    console.error('Error Supabase:', error);
                    document.getElementById('catalog-mount').innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:50px;">Error cargando productos.<br>${error.message}</div>`;
                    return;
                }
                if (!dbProducts || dbProducts.length === 0) {
                     document.getElementById('catalog-mount').innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:50px;">La base de datos está vacía.<br>Agrega productos en Supabase.</div>`;
                     return;
                }

                this.data = dbProducts.map(p => ({
                    id: p.id,
                    name: p.name,
                    cat: p.category, 
                    price: parseFloat(p.price),
                    img: p.image,    
                    stock: parseInt(p.stock),
                    desc: p.description 
                }));

                this.renderPills(); this.renderCatalog();
                document.getElementById('search-input').addEventListener('keyup', ()=>this.renderCatalog());
                document.getElementById('product-modal').addEventListener('click', (e)=>{ if(e.target.id === 'product-modal') this.closeModal(); });
            },

            renderPills: function() {
                const cats = ['Todos', ...new Set(this.data.map(p=>p.cat))];
                document.getElementById('pills-mount').innerHTML = cats.map(c => 
                    `<div class="pill ${c===this.filter?'active':''}" onclick="app.setFilter('${c}')">${c}</div>`
                ).join('');
            },
            setFilter: function(c) { this.filter = c; this.renderPills(); this.renderCatalog(); },
            renderCatalog: function() {
                const q = document.getElementById('search-input').value.toLowerCase();
                const items = this.data.filter(p => (this.filter==='Todos'||p.cat===this.filter) && p.name.toLowerCase().includes(q));
                document.getElementById('catalog-mount').innerHTML = items.map(p => {
                    const out = p.stock <= 0;
                    return `
                    <div class="product-card">
                        <div class="card-image-wrapper" onclick="app.openModal('${p.id}')">
                            <span class="stock-badge" style="background:${out?'#ef4444':'rgba(0,0,0,0.7)'}">${out?'AGOTADO':'Stock: '+p.stock}</span>
                            <img src="${p.img}" class="product-img" onerror="this.src='https://via.placeholder.com/300?text=JstoreR'">
                        </div>
                        <div class="card-info">
                            <div class="card-category">${p.cat}</div>
                            <h3 class="card-title">${p.name}</h3>
                            <div class="card-desc-snippet">${p.desc || ''}</div>
                            <div class="card-bottom">
                                <span class="card-price">S/ ${p.price.toFixed(2)}</span>
                                <button class="btn-add-cart" onclick="app.add('${p.id}')" ${out?'disabled':''}><i class="fa-solid fa-plus"></i></button>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },
            add: function(id) {
                const p = this.data.find(x=>x.id===id);
                const exist = this.cart.find(x=>x.id===id);
                if(exist) {
                    if(exist.qty < p.stock) exist.qty++;
                    else return alert("Stock máximo alcanzado");
                } else {
                    if(p.stock>0) this.cart.push({id:p.id, p:p, qty:1});
                }
                this.renderCart(); this.toast("Agregado al carrito");
            },
            modQty: function(id, d) {
                const item = this.cart.find(x=>x.id===id);
                if(!item) return;
                const n = item.qty + d;
                if(n > item.p.stock) return alert("Sin stock");
                if(n <= 0) this.cart = this.cart.filter(x=>x.id!==id);
                else item.qty = n;
                this.renderCart();
            },
            renderCart: function() {
                document.getElementById('cart-count').innerText = this.cart.reduce((a,b)=>a+b.qty,0);
                const sub = this.cart.reduce((a,b)=>a+(b.p.price*b.qty),0);
                document.getElementById('cart-subtotal').innerText = "S/ " + sub.toFixed(2);
                
                const bar = document.getElementById('shipping-bar');
                const msg = document.getElementById('shipping-msg');
                const amt = document.getElementById('shipping-amt');
                const pct = Math.min((sub / FREE_SHIPPING_THRESHOLD) * 100, 100);
                
                bar.style.width = pct + "%";
                if(sub >= FREE_SHIPPING_THRESHOLD) {
                    bar.classList.add('success');
                    msg.innerHTML = "<i class='fa-solid fa-gift'></i> ¡GENIAL! TIENES ENVÍO GRATIS";
                    msg.style.color = "var(--success)";
                    amt.innerText = "";
                } else {
                    bar.classList.remove('success');
                    const left = (FREE_SHIPPING_THRESHOLD - sub).toFixed(2);
                    msg.innerHTML = `Agrega <strong>S/ ${left}</strong> para envío gratis`;
                    msg.style.color = "white";
                    amt.innerText = `S/ ${sub} / ${FREE_SHIPPING_THRESHOLD}`;
                }

                const list = document.getElementById('cart-list');
                if(this.cart.length === 0) {
                    list.innerHTML = `<div style="text-align:center; margin-top:50px; color:#6b7280; opacity:0.6;"><i class="fa-solid fa-basket-shopping fa-3x"></i><br><br>Tu carrito está vacío</div>`;
                } else {
                    list.innerHTML = this.cart.map(i => `
                        <div class="cart-row">
                            <img src="${i.p.img}" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
                            <div style="flex:1;">
                                <div style="font-weight:700; font-size:0.9rem;">${i.p.name}</div>
                                <div style="color:var(--accent-gold);">S/ ${i.p.price.toFixed(2)}</div>
                                <div class="qty-control">
                                    <button class="qty-btn" onclick="app.modQty('${i.id}',-1)">-</button>
                                    <span>${i.qty}</span>
                                    <button class="qty-btn" onclick="app.modQty('${i.id}',1)">+</button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                this.updateCheckoutTotals();
            },
            updateCheckoutTotals: function() {
                const sub = this.cart.reduce((a,b)=>a+(b.p.price*b.qty),0);
                const baseShip = parseFloat(document.getElementById('calc-ship-base').value) || 0;
                let finalShip = baseShip;
                const discRow = document.getElementById('discount-row');
                const discVal = document.getElementById('discount-val');
                
                if(sub >= FREE_SHIPPING_THRESHOLD && baseShip > 0) {
                    finalShip = 0;
                    discRow.style.display = 'flex';
                    discVal.innerText = baseShip.toFixed(2);
                } else {
                    discRow.style.display = 'none';
                }
                
                document.getElementById('calc-ship-final').value = finalShip.toFixed(2);
                if(document.getElementById('total-txt')) {
                    document.getElementById('total-txt').innerText = "S/ " + (sub + finalShip).toFixed(2);
                }
            },
            openModal: function(id) {
                const p = this.data.find(x=>x.id===id);
                document.getElementById('m-img').src = p.img;
                document.getElementById('m-cat').innerText = p.cat;
                document.getElementById('m-title').innerText = p.name;
                document.getElementById('m-price').innerText = "S/ "+p.price.toFixed(2);
                document.getElementById('m-desc').innerText = p.desc;
                const btn = document.getElementById('m-btn');
                if(p.stock<=0) { btn.innerText="AGOTADO"; btn.disabled=true; }
                else { btn.innerText="Agregar al Carrito"; btn.disabled=false; btn.onclick=()=> {this.add(id); this.closeModal();} }
                document.getElementById('product-modal').classList.add('active');
            },
            closeModal: function() { document.getElementById('product-modal').classList.remove('active'); },
            toggleSidebar: function() { 
                document.getElementById('sidebar').classList.toggle('active');
                if(!document.getElementById('sidebar').classList.contains('active')) this.backToCart();
            },
            goToCheckout: function() { if(this.cart.length) document.getElementById('sidebar').classList.add('checkout-mode'); },
            backToCart: function() { document.getElementById('sidebar').classList.remove('checkout-mode'); },
            
            toggleFaq: function(el) {
                const item = el.parentElement;
                const content = item.querySelector('.accordion-content');
                document.querySelectorAll('.accordion-item').forEach(it => {
                    if(it !== item) {
                        it.classList.remove('active');
                        it.querySelector('.accordion-content').style.maxHeight = null;
                    }
                });
                item.classList.toggle('active');
                if (item.classList.contains('active')) {
                    content.style.maxHeight = content.scrollHeight + "px";
                } else {
                    content.style.maxHeight = null;
                }
            },

            finalize: function() {
                const name = document.getElementById('cust-name').value;
                const addr = document.getElementById('cust-address').value;
                const pay = document.getElementById('cust-pay').value;
                const dist = document.getElementById('dist-txt').innerText;
                const finalShip = document.getElementById('calc-ship-final').value;
                
                if(!name || !addr) return alert("Completa tus datos de envío");
                
                let msg = `*PEDIDO WEB JSTORE-R* 🛍️\n─────────────────────\n👤 *Cliente:* ${name}\n📍 *Dirección:* ${addr}\n`;
                if(document.getElementById('geo-lat').value) msg += `🗺️ *Mapa:* https://www.google.com/maps/search/?api=1&query=${document.getElementById('geo-lat').value},${document.getElementById('geo-lng').value}\n`;
                
                msg += `🚚 *Logística:* ${dist} (S/ ${finalShip})\n`;
                if(finalShip == 0) msg += `🎉 *ENVÍO GRATIS APLICADO*\n`;
                
                msg += `💳 *Pago:* ${pay}\n─────────────────────\n*DETALLE:*\n`;
                this.cart.forEach(i => msg += `• [${i.qty}] ${i.p.name}\n`);
                const sub = this.cart.reduce((a,b)=>a+(b.p.price*b.qty),0);
                const total = (sub + parseFloat(finalShip)).toFixed(2);
                
                msg += `\n🛒 *Subtotal:* S/ ${sub.toFixed(2)}\n💰 *TOTAL FINAL:* S/ ${total}`;
                window.open(`https://wa.me/51932508670?text=${encodeURIComponent(msg)}`);
            },
            toast: function(m) {
                const t = document.getElementById('toast'); t.innerHTML = `<i class="fa-solid fa-check"></i> ${m}`; t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 2000);
            },
            initGoldDust: function() {
                const cvs = document.getElementById('gold-dust'); const ctx = cvs.getContext('2d'); let w, h, p = [];
                const resize = () => { w = cvs.width = window.innerWidth; h = cvs.height = window.innerHeight; };
                const loop = () => { ctx.clearRect(0,0,w,h); ctx.fillStyle = "rgba(212, 175, 55, 0.5)"; p.forEach(pt => { ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.r, 0, Math.PI*2); ctx.fill(); pt.y -= pt.s; pt.x += Math.sin(pt.y/30) * 0.5; if(pt.y < 0) pt.y = h; }); requestAnimationFrame(loop); };
                resize(); for(let i=0; i<50; i++) p.push({ x:Math.random()*w, y:Math.random()*h, r:Math.random()*2, s:Math.random()*0.5+0.1 }); window.addEventListener('resize', resize); loop();
            }
        };

        document.addEventListener('DOMContentLoaded', ()=>app.init());
    </script>
</body>
</html>
