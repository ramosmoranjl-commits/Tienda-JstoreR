<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111827">
    <meta name="robots" content="index, follow">

    <title>JstoreR · Official Store</title>
    <meta name="description" content="Catálogo exclusivo sincronizado en tiempo real. Envíos geolocalizados.">

    <link rel="icon" type="image/png" href="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;1,400&family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* ==========================================================================
           1. CORE DESIGN SYSTEM (TOKENS)
           ========================================================================== */
        :root {
            /* Palette: Dark Obsidian & Gold Luxury */
            --c-bg-body: #f8fafc;
            --c-bg-card: #ffffff;
            --c-header: #111827;       /* Header Original Oscuro */
            --c-text-header: #f9fafb;
            --c-text-main: #1e293b;
            --c-text-muted: #64748b;
            
            --c-accent: #d4af37;       /* Oro */
            --c-accent-hover: #b4941f;
            --c-success: #10b981;
            --c-danger: #ef4444;
            --c-overlay: rgba(0, 0, 0, 0.6);

            /* Typography */
            --f-display: 'Playfair Display', serif;
            --f-body: 'Plus Jakarta Sans', sans-serif;

            /* Spacing & Layout */
            --container: 1400px;
            --header-h: 70px;
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;

            /* Effects */
            --shadow-card: 0 10px 40px -10px rgba(0,0,0,0.08);
            --shadow-float: 0 20px 50px -12px rgba(0,0,0,0.15);
            --ease-elastic: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Z-Index Layers */
            --z-gold: 100;
            --z-header: 800;
            --z-filters: 700;
            --z-modal: 2000;
            --z-toast: 3000;
        }

        /* RESET & BASE */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--f-body); background: var(--c-bg-body); color: var(--c-text-main);
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
        }
        
        /* SCROLLBAR CUSTOMIZATION */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--c-accent); }

        /* ==========================================================================
           2. HEADER & NAVIGATION (CLASSIC STYLE)
           ========================================================================== */
        .header-master {
            background: var(--c-header);
            color: var(--c-text-header);
            height: var(--header-h);
            position: sticky; top: 0; z-index: var(--z-header);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s;
        }
        
        .header-inner {
            max-width: var(--container); margin: 0 auto; height: 100%;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; gap: 20px;
        }

        .brand-logo {
            font-family: var(--f-display); font-size: 1.6rem; font-weight: 700;
            color: var(--c-accent); text-decoration: none; letter-spacing: 0.5px;
            display: flex; align-items: center; gap: 10px; flex-shrink: 0;
        }
        .brand-logo span { color: white; }

        /* SMART SEARCH BAR */
        .search-dock {
            flex-grow: 1; max-width: 500px; position: relative;
        }
        .search-input {
            width: 100%; padding: 10px 20px 10px 45px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
            border-radius: 50px; color: white; font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        .search-input::placeholder { color: rgba(255,255,255,0.5); }
        .search-input:focus {
            background: rgba(255,255,255,0.15); border-color: var(--c-accent);
            outline: none; box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }
        .search-icon {
            position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
            color: var(--c-accent); font-size: 1rem; pointer-events: none;
        }

        /* CART TRIGGER */
        .cart-btn {
            position: relative; cursor: pointer; padding: 8px;
            color: white; transition: transform 0.2s;
        }
        .cart-btn:hover { transform: scale(1.1); color: var(--c-accent); }
        .badge-count {
            position: absolute; top: 0; right: -5px;
            background: var(--c-accent); color: var(--c-header);
            font-size: 0.7rem; font-weight: 800;
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* ==========================================================================
           3. DYNAMIC PILLS & FILTERS
           ========================================================================== */
        .filters-strip {
            background: white; border-bottom: 1px solid #e2e8f0;
            position: sticky; top: var(--header-h); z-index: var(--z-filters);
            padding: 12px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }
        .pills-container {
            max-width: var(--container); margin: 0 auto; padding: 0 24px;
            display: flex; gap: 10px; overflow-x: auto;
            scrollbar-width: none;
        }
        .pills-container::-webkit-scrollbar { display: none; }

        .pill {
            padding: 8px 20px; border-radius: 100px; font-size: 0.85rem; font-weight: 600;
            background: #f1f5f9; color: var(--c-text-muted); cursor: pointer;
            border: 1px solid transparent; white-space: nowrap; transition: 0.3s;
        }
        .pill:hover { background: #e2e8f0; color: var(--c-text-main); }
        .pill.active {
            background: var(--c-header); color: var(--c-accent);
            border-color: var(--c-header); box-shadow: 0 4px 12px rgba(17, 24, 39, 0.2);
        }

        /* ==========================================================================
           4. PRODUCT GRID & CARDS
           ========================================================================== */
        .catalog-wrapper {
            max-width: var(--container); margin: 40px auto; padding: 0 24px;
            flex: 1; min-height: 60vh;
        }
        
        .grid-layout {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 30px;
        }

        .card {
            background: var(--c-bg-card); border-radius: var(--radius-md);
            border: 1px solid rgba(0,0,0,0.04); overflow: hidden;
            transition: all 0.4s var(--ease-smooth); position: relative;
            display: flex; flex-direction: column; height: 100%;
        }
        .card:hover {
            transform: translateY(-8px); box-shadow: var(--shadow-float);
            border-color: rgba(212, 175, 55, 0.2);
        }

        /* IMAGE AREA */
        .card-img-wrap {
            position: relative; width: 100%; padding-top: 100%; /* 1:1 Aspect */
            background: #f8fafc; overflow: hidden; cursor: pointer;
        }
        .card-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; transition: transform 0.8s ease;
        }
        .card:hover .card-img { transform: scale(1.1); }
        
        .stock-tag {
            position: absolute; top: 12px; right: 12px;
            background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(4px);
            color: white; font-size: 0.7rem; font-weight: 700;
            padding: 4px 10px; border-radius: 4px; z-index: 2;
        }
        .stock-tag.out { background: var(--c-danger); }

        /* CONTENT AREA */
        .card-body { padding: 16px; flex: 1; display: flex; flex-direction: column; }
        
        .card-cat {
            font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
            color: var(--c-text-muted); font-weight: 700; margin-bottom: 6px;
        }
        .card-title {
            font-size: 1rem; font-weight: 700; color: var(--c-text-main);
            margin-bottom: 12px; line-height: 1.4; flex-grow: 1;
        }
        
        .card-footer {
            display: flex; justify-content: space-between; align-items: center;
            border-top: 1px solid #f1f5f9; padding-top: 12px; margin-top: auto;
        }
        .card-price {
            font-size: 1.2rem; font-weight: 800; color: var(--c-text-main);
        }
        
        .btn-add {
            width: 42px; height: 42px; border-radius: 50%; border: none;
            background: var(--c-header); color: var(--c-accent); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.3s var(--ease-elastic); font-size: 1.1rem;
        }
        .btn-add:hover { background: var(--c-accent); color: var(--c-header); transform: scale(1.1); }
        .btn-add:disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; transform: none; }

        /* CARD AGOTADA STATE */
        .card.is-out .card-img-wrap { filter: grayscale(1); opacity: 0.8; }
        .card.is-out .card-title { color: #94a3b8; }

        /* ==========================================================================
           5. PRODUCT DETAIL MODAL (NEW FEATURE FOR COLUMN G)
           ========================================================================== */
        .modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            z-index: var(--z-modal); display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px;
        }
        .modal-backdrop.active { opacity: 1; pointer-events: all; }

        .modal-content {
            background: white; width: 100%; max-width: 900px; border-radius: var(--radius-lg);
            overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;
            transform: translateY(30px); transition: 0.4s var(--ease-elastic); box-shadow: var(--shadow-float);
        }
        .modal-backdrop.active .modal-content { transform: translateY(0); }

        /* Layout Modal PC */
        @media(min-width: 768px) {
            .modal-content { flex-direction: row; }
            .modal-img-col { width: 50%; height: auto; }
            .modal-info-col { width: 50%; overflow-y: auto; }
        }

        .modal-img-col {
            background: #f8fafc; position: relative; min-height: 300px;
        }
        .modal-img {
            width: 100%; height: 100%; object-fit: cover; position: absolute;
        }
        .btn-close-modal {
            position: absolute; top: 15px; right: 15px; background: white; width: 36px; height: 36px;
            border-radius: 50%; border: none; cursor: pointer; z-index: 10; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .modal-info-col { padding: 30px; display: flex; flex-direction: column; }
        .modal-cat { color: var(--c-accent); font-weight: 700; text-transform: uppercase; font-size: 0.8rem; margin-bottom: 10px; }
        .modal-title { font-family: var(--f-display); font-size: 2rem; line-height: 1.1; margin-bottom: 20px; }
        .modal-desc { font-size: 1rem; line-height: 1.7; color: var(--c-text-muted); margin-bottom: 30px; white-space: pre-line; }
        .modal-price { font-size: 1.8rem; font-weight: 800; margin-bottom: 20px; }
        
        .btn-modal-action {
            width: 100%; padding: 18px; background: var(--c-header); color: var(--c-accent);
            border: none; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer;
            transition: 0.3s; margin-top: auto;
        }
        .btn-modal-action:hover { background: var(--c-accent); color: white; }

        /* ==========================================================================
           6. CART & CHECKOUT SIDEBAR
           ========================================================================== */
        .sidebar {
            position: fixed; top: 0; right: -100%; width: 100%; max-width: 480px; height: 100%;
            background: white; z-index: 2500; transition: 0.5s cubic-bezier(0.7, 0, 0.3, 1);
            display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.2);
        }
        .sidebar.active { right: 0; }

        .cart-header {
            padding: 20px 24px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;
        }
        .cart-steps-container { flex: 1; position: relative; overflow: hidden; }
        
        .step-view {
            position: absolute; inset: 0; padding: 24px; overflow-y: auto; transition: transform 0.4s ease;
            display: flex; flex-direction: column;
        }
        #view-cart { transform: translateX(0); }
        #view-checkout { transform: translateX(100%); }

        /* Checkout Mode */
        .sidebar.checkout-mode #view-cart { transform: translateX(-100%); }
        .sidebar.checkout-mode #view-checkout { transform: translateX(0); }

        /* Cart Items */
        .cart-item {
            display: flex; gap: 15px; margin-bottom: 20px; border: 1px solid #f1f5f9; padding: 12px; border-radius: 12px;
        }
        .cart-item img { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; }
        .cart-item-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .cart-item-title { font-weight: 700; font-size: 0.9rem; line-height: 1.2; margin-bottom: 4px; }
        .cart-item-price { color: var(--c-accent); font-weight: 600; }
        .btn-remove { background: #fee2e2; color: var(--c-danger); border: none; width: 30px; height: 30px; border-radius: 8px; cursor: pointer; }

        /* Geo Module */
        .geo-module {
            background: #f8fafc; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 15px; margin-bottom: 20px;
        }
        .btn-geo {
            width: 100%; padding: 12px; background: #dbeafe; color: #1e40af; border: 1px solid #bfdbfe;
            border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.3s; margin-bottom: 10px;
        }
        .btn-geo:hover { background: #bfdbfe; }
        #map-container { height: 0; overflow: hidden; transition: height 0.4s; border-radius: 8px; }
        #map-container.active { height: 200px; border: 1px solid #cbd5e1; }

        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.95rem; }
        .input-field:focus { border-color: var(--c-accent); outline: none; }

        .btn-checkout {
            margin-top: auto; padding: 18px; width: 100%; background: var(--c-header); color: white;
            border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1.1rem;
        }
        .btn-whatsapp { background: #25D366; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        /* ==========================================================================
           7. FOOTER (RESTORED)
           ========================================================================== */
        .footer-legacy {
            background: var(--c-header); color: rgba(255,255,255,0.7); padding: 80px 20px 40px; margin-top: auto;
        }
        .footer-grid {
            max-width: var(--container); margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px;
        }
        .f-col h4 { color: white; font-family: var(--f-display); margin-bottom: 25px; font-size: 1.3rem; }
        .f-col ul { list-style: none; }
        .f-col li { margin-bottom: 12px; }
        .f-col a { color: inherit; text-decoration: none; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .f-col a:hover { color: var(--c-accent); transform: translateX(5px); }
        .f-copy { text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 30px; margin-top: 50px; font-size: 0.9rem; }

        /* ==========================================================================
           8. EXTRAS (TOASTS & LOADERS)
           ========================================================================== */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(50px);
            background: rgba(17, 24, 39, 0.95); color: white; padding: 12px 30px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); opacity: 0; transition: 0.4s var(--ease-elastic);
            z-index: var(--z-toast); font-weight: 600; pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        #gold-dust { position: fixed; inset: 0; pointer-events: none; z-index: var(--z-gold); }

        /* SKELETON LOADER */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    </style>
</head>
<body>

    <canvas id="gold-dust"></canvas>
    <div id="toast" class="toast">Producto agregado</div>

    <header class="header-master">
        <div class="header-inner">
            <a href="#" class="brand-logo">JSTORE<span>R</span></a>
            
            <div class="search-dock">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" id="search-input" placeholder="Buscar por nombre, categoría...">
            </div>

            <div class="cart-btn" onclick="app.toggleCart()">
                <i class="fa-solid fa-bag-shopping" style="font-size: 1.4rem;"></i>
                <div class="badge-count" id="cart-badge">0</div>
            </div>
        </div>
    </header>

    <nav class="filters-strip">
        <div class="pills-container" id="pills-mount">
            <div class="skeleton" style="width:80px; height:36px; border-radius:50px;"></div>
            <div class="skeleton" style="width:100px; height:36px; border-radius:50px;"></div>
            <div class="skeleton" style="width:90px; height:36px; border-radius:50px;"></div>
        </div>
    </nav>

    <main class="catalog-wrapper">
        <div class="grid-layout" id="catalog-mount">
            <div class="card" style="height:350px;"><div class="skeleton" style="width:100%; height:100%;"></div></div>
            <div class="card" style="height:350px;"><div class="skeleton" style="width:100%; height:100%;"></div></div>
            <div class="card" style="height:350px;"><div class="skeleton" style="width:100%; height:100%;"></div></div>
            <div class="card" style="height:350px;"><div class="skeleton" style="width:100%; height:100%;"></div></div>
        </div>
    </main>

    <div class="modal-backdrop" id="product-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="app.closeModal()"><i class="fa-solid fa-times"></i></button>
            
            <div class="modal-img-col">
                <img id="m-img" class="modal-img" src="" alt="">
            </div>
            
            <div class="modal-info-col">
                <div id="m-cat" class="modal-cat">CATEGORÍA</div>
                <h2 id="m-title" class="modal-title">Nombre Producto</h2>
                <div id="m-price" class="modal-price">S/ 0.00</div>
                <hr style="border:0; border-top:1px solid #f1f5f9; margin-bottom:20px;">
                <h4 style="font-weight:700; margin-bottom:10px;">Descripción Detallada</h4>
                <p id="m-desc" class="modal-desc">Descripción completa...</p>
                
                <button id="m-btn-add" class="btn-modal-action">Agregar al Carrito</button>
            </div>
        </div>
    </div>

    <div class="sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3 style="font-family:var(--f-display)">Tu Bolsa</h3>
            <button onclick="app.toggleCart()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>

        <div class="cart-steps-container">
            <div class="step-view" id="view-cart">
                <div id="cart-list" style="flex:1;"></div>
                
                <div style="border-top:1px solid #f1f5f9; padding-top:20px;">
                    <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:800; margin-bottom:20px;">
                        <span>Total</span>
                        <span id="cart-total">S/ 0.00</span>
                    </div>
                    <button class="btn-checkout" onclick="app.goToCheckout()">Continuar Compra</button>
                </div>
            </div>

            <div class="step-view" id="view-checkout">
                <button onclick="app.backToCart()" style="background:none; border:none; cursor:pointer; color:#64748b; margin-bottom:15px; display:flex; align-items:center; gap:5px;">
                    <i class="fa-solid fa-arrow-left"></i> Volver
                </button>
                
                <h3 style="margin-bottom:15px; font-family:var(--f-display)">Datos de Entrega</h3>
                
                <div class="input-group">
                    <input type="text" id="input-name" class="input-field" placeholder="Tu Nombre Completo">
                </div>

                <div class="geo-module">
                    <button class="btn-geo" onclick="geo.locate()">
                        <i class="fa-solid fa-location-crosshairs"></i> Detectar Ubicación GPS
                    </button>
                    <div id="geo-status" style="text-align:center; font-size:0.8rem; color:#64748b; margin-bottom:5px;"></div>
                    <div id="map-container"><div id="map" style="width:100%; height:100%;"></div></div>
                    <input type="hidden" id="geo-lat">
                    <input type="hidden" id="geo-lng">
                </div>

                <div class="input-group">
                    <input type="text" id="input-address" class="input-field" placeholder="Dirección escrita (Calle, Nro, Ref)">
                </div>

                <div class="input-group">
                    <select id="input-payment" class="input-field">
                        <option value="Yape/Plin">Yape o Plin</option>
                        <option value="Transferencia">Transferencia BCP</option>
                        <option value="Efectivo">Contra Entrega</option>
                    </select>
                </div>

                <button class="btn-checkout btn-whatsapp" onclick="app.finalizeOrder()">
                    <i class="fa-brands fa-whatsapp" style="font-size:1.3rem;"></i> Enviar Pedido
                </button>
            </div>
        </div>
    </div>

    <footer class="footer-legacy">
        <div class="footer-grid">
            <div class="f-col">
                <h4>JStoreR</h4>
                <p>La definición de lujo accesible. Importadores directos con garantía y soporte local.</p>
                <div style="margin-top:20px; display:flex; gap:15px;">
                    <i class="fa-brands fa-instagram" style="font-size:1.5rem; cursor:pointer;"></i>
                    <i class="fa-brands fa-tiktok" style="font-size:1.5rem; cursor:pointer;"></i>
                    <i class="fa-brands fa-facebook" style="font-size:1.5rem; cursor:pointer;"></i>
                </div>
            </div>
            <div class="f-col">
                <h4>Navegación</h4>
                <ul>
                    <li><a href="#">Inicio</a></li>
                    <li><a href="#">Catálogo Completo</a></li>
                    <li><a href="#">Rastrea tu pedido</a></li>
                </ul>
            </div>
            <div class="f-col">
                <h4>Atención al Cliente</h4>
                <ul>
                    <li><a href="#"><i class="fa-brands fa-whatsapp"></i> +51 932 508 670</a></li>
                    <li><a href="#"><i class="fa-regular fa-envelope"></i> contacto@jstorer.com</a></li>
                    <li><a href="#"><i class="fa-solid fa-location-dot"></i> Lima, Perú</a></li>
                </ul>
            </div>
        </div>
        <div class="f-copy">
            © 2026 JstoreR Inc. Todos los derechos reservados. | Design by Senior Dev AI
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        /**
         * ============================================================================
         * JSTORE-R CORE LOGIC v5.0
         * Handles: CSV Parsing, State Management, Geo-Location, Modal System
         * ============================================================================
         */

        // 1. CONFIGURACIÓN
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOKWE4Wyh_N_pt12iDlXx_garwZHFKRcE19DRoKSa2Cb_v3KoSmcQcJXRS2MdrfB7Bso-DqSXdINSt/pub?gid=0&single=true&output=csv"; // PEGA TU ENLACE AQUÍ
        
        // Mapeo de Columnas (Excel: A=0, B=1, C=2, D=3, E=4, F=5, G=6)
        const IDX = { ID: 0, NAME: 1, CAT: 2, PRICE: 3, IMG: 4, STOCK: 5, DESC: 6 };

        // 2. GEO-ENGINE (Leaflet)
        const geo = {
            map: null, marker: null,
            init: function() {
                if(this.map) return;
                this.map = L.map('map').setView([-12.046, -77.042], 13); // Lima Center
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
                this.marker = L.marker([-12.046, -77.042], {draggable:true}).addTo(this.map);
                
                this.marker.on('dragend', (e) => {
                    const pos = e.target.getLatLng();
                    this.updateInputs(pos.lat, pos.lng);
                });
            },
            locate: function() {
                const status = document.getElementById('geo-status');
                const container = document.getElementById('map-container');
                status.innerText = "Solicitando acceso satelital...";
                container.classList.add('active');

                // Fix Leaflet gray box
                setTimeout(() => { if(!this.map) this.init(); this.map.invalidateSize(); }, 300);

                if(!navigator.geolocation) return status.innerText = "GPS no disponible en este dispositivo.";

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const {latitude, longitude} = pos.coords;
                        this.map.setView([latitude, longitude], 17);
                        this.marker.setLatLng([latitude, longitude]);
                        this.updateInputs(latitude, longitude);
                        status.innerHTML = "<span style='color:green'>✔ Ubicación Detectada con Precisión</span>";
                        
                        // Reverse Geocode
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${latitude}&lon=${longitude}`)
                        .then(r=>r.json()).then(d => {
                            document.getElementById('input-address').value = d.display_name;
                        });
                    },
                    (err) => {
                        console.error(err);
                        status.innerText = "No se pudo obtener GPS. Usa el mapa manual.";
                    },
                    { enableHighAccuracy: true }
                );
            },
            updateInputs: function(lat, lng) {
                document.getElementById('geo-lat').value = lat;
                document.getElementById('geo-lng').value = lng;
            }
        };

        // 3. APP CONTROLLER
        const app = {
            products: [],
            cart: [],
            activeFilter: 'Todos',

            init: async function() {
                this.initGoldDust();
                this.setupListeners();
                await this.fetchData();
            },

            // CSV PARSER ROBUSTO (Soporta comas dentro de descripción)
            fetchData: async function() {
                try {
                    if(GOOGLE_SHEET_CSV_URL.includes("AQUI_TU")) throw new Error("URL no configurada");
                    
                    const res = await fetch(GOOGLE_SHEET_CSV_URL);
                    const text = await res.text();
                    
                    const rows = text.split('\n').slice(1); // Ignorar Header Row
                    
                    this.products = rows.map(row => {
                        // Regex mágica para parsear CSV respetando comillas
                        const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        if(!cols || cols.length < 6) return null;
                        
                        // Limpiador de comillas
                        const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';

                        return {
                            id: clean(cols[IDX.ID]),
                            name: clean(cols[IDX.NAME]),
                            cat: clean(cols[IDX.CAT]),
                            price: parseFloat(clean(cols[IDX.PRICE]).replace(/[^0-9.]/g, '')) || 0,
                            img: clean(cols[IDX.IMG]),
                            stock: parseInt(clean(cols[IDX.STOCK])) || 0,
                            desc: clean(cols[IDX.DESC]) || "Sin descripción detallada."
                        };
                    }).filter(p => p !== null && p.name); // Filtrar filas vacías

                    this.renderPills();
                    this.renderCatalog();

                } catch (error) {
                    console.warn("Usando datos Demo:", error);
                    // DATOS DEMO PARA QUE VEAS QUE FUNCIONA
                    this.products = [
                        {id:'101', name:'Rolex Submariner', cat:'Relojes', price:45000, stock:2, img:'https://images.unsplash.com/photo-1523170335258-f5ed11844a49', desc:'Acero Oystersteel, bisel giratorio unidireccional Cerachrom. Resistente al agua 300m.'},
                        {id:'102', name:'MacBook Pro M3', cat:'Tech', price:12500, stock:0, img:'https://images.unsplash.com/photo-1517336714731-489689fd1ca4', desc:'Chip M3 Max, 32GB RAM unificada, 1TB SSD. Pantalla Liquid Retina XDR.'},
                        {id:'103', name:'Bolso Louis Vuitton', cat:'Moda', price:8500, stock:5, img:'https://images.unsplash.com/photo-1548036328-c9fa89d128fa', desc:'Canvas Monogram icónico. Asas de piel natural. Interior espacioso.'}
                    ];
                    this.renderPills();
                    this.renderCatalog();
                }
            },

            renderPills: function() {
                const cats = ['Todos', ...new Set(this.products.map(p => p.cat))];
                document.getElementById('pills-mount').innerHTML = cats.map(c => `
                    <div class="pill ${c === 'Todos' ? 'active' : ''}" onclick="app.setFilter('${c}', this)">${c}</div>
                `).join('');
            },

            setFilter: function(cat, el) {
                this.activeFilter = cat;
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                el.classList.add('active');
                this.renderCatalog();
            },

            renderCatalog: function() {
                const search = document.getElementById('search-input').value.toLowerCase();
                const filtered = this.products.filter(p => {
                    const matchesCat = this.activeFilter === 'Todos' || p.cat === this.activeFilter;
                    const matchesSearch = p.name.toLowerCase().includes(search) || p.cat.toLowerCase().includes(search);
                    return matchesCat && matchesSearch;
                });

                const container = document.getElementById('catalog-mount');
                if(filtered.length === 0) {
                    container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px;"><h3>No se encontraron productos</h3></div>`;
                    return;
                }

                container.innerHTML = filtered.map(p => {
                    const isOut = p.stock <= 0;
                    return `
                    <article class="card ${isOut ? 'is-out' : ''}">
                        <div class="card-img-wrap" onclick="app.openDetails('${p.id}')">
                            <span class="stock-tag ${isOut ? 'out' : ''}">${isOut ? 'AGOTADO' : 'Stock: '+p.stock}</span>
                            <img src="${p.img}" class="card-img" loading="lazy">
                        </div>
                        <div class="card-body">
                            <div class="card-cat">${p.cat}</div>
                            <h3 class="card-title">${p.name}</h3>
                            <div class="card-footer">
                                <span class="card-price">S/ ${p.price.toLocaleString()}</span>
                                <button class="btn-add" 
                                    onclick="app.addToCart('${p.id}')" 
                                    ${isOut ? 'disabled' : ''}>
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </article>
                `}).join('');
            },

            // --- MODAL SYSTEM (COLUMNA G) ---
            openDetails: function(id) {
                const p = this.products.find(x => x.id === id);
                if(!p) return;

                document.getElementById('m-img').src = p.img;
                document.getElementById('m-cat').innerText = p.cat;
                document.getElementById('m-title').innerText = p.name;
                document.getElementById('m-price').innerText = `S/ ${p.price.toLocaleString()}`;
                document.getElementById('m-desc').innerText = p.desc || "Sin descripción."; // Aquí carga la Columna G

                const btn = document.getElementById('m-btn-add');
                if(p.stock <= 0) {
                    btn.disabled = true;
                    btn.innerText = "AGOTADO";
                    btn.style.background = "#e2e8f0";
                    btn.style.color = "#94a3b8";
                } else {
                    btn.disabled = false;
                    btn.innerText = "Agregar al Carrito";
                    btn.style.background = "#111827";
                    btn.style.color = "#d4af37";
                    btn.onclick = () => { this.addToCart(p.id); this.closeModal(); };
                }

                document.getElementById('product-modal').classList.add('active');
            },
            closeModal: function() {
                document.getElementById('product-modal').classList.remove('active');
            },

            // --- CART SYSTEM ---
            addToCart: function(id) {
                const p = this.products.find(x => x.id === id);
                const currentInCart = this.cart.filter(x => x.id === id).length;

                if(currentInCart >= p.stock) {
                    alert("No hay más stock disponible de este producto.");
                    return;
                }

                this.cart.push(p);
                this.updateCartUI();
                this.showToast(`Agregado: ${p.name}`);
                
                // Animar badge
                const b = document.getElementById('cart-badge');
                b.style.transform = 'scale(1.5)';
                setTimeout(()=>b.style.transform='scale(1)', 200);
            },

            removeFromCart: function(index) {
                this.cart.splice(index, 1);
                this.updateCartUI();
            },

            updateCartUI: function() {
                document.getElementById('cart-badge').innerText = this.cart.length;
                
                const list = document.getElementById('cart-list');
                const totalEl = document.getElementById('cart-total');
                const total = this.cart.reduce((a,b)=>a+b.price,0);
                
                totalEl.innerText = `S/ ${total.toLocaleString()}`;

                if(this.cart.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding:40px; color:#94a3b8;">Tu bolsa está vacía</div>`;
                } else {
                    list.innerHTML = this.cart.map((p, i) => `
                        <div class="cart-item">
                            <img src="${p.img}">
                            <div class="cart-item-info">
                                <div class="cart-item-title">${p.name}</div>
                                <div class="cart-item-price">S/ ${p.price.toLocaleString()}</div>
                            </div>
                            <button class="btn-remove" onclick="app.removeFromCart(${i})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `).join('');
                }
            },

            toggleCart: function() {
                const sb = document.getElementById('cart-sidebar');
                const isOpen = sb.classList.contains('active');
                if(isOpen) {
                    sb.classList.remove('active');
                    setTimeout(()=>this.backToCart(), 500); // Reset steps
                } else {
                    sb.classList.add('active');
                }
            },

            goToCheckout: function() {
                if(this.cart.length === 0) return alert("Agrega productos primero");
                document.getElementById('cart-sidebar').classList.add('checkout-mode');
            },
            backToCart: function() {
                document.getElementById('cart-sidebar').classList.remove('checkout-mode');
            },

            finalizeOrder: function() {
                const name = document.getElementById('input-name').value;
                const addr = document.getElementById('input-address').value;
                const pay = document.getElementById('input-payment').value;
                const lat = document.getElementById('geo-lat').value;
                const lng = document.getElementById('geo-lng').value;

                if(!name || !addr) return alert("Por favor ingresa Nombre y Dirección");

                let msg = `*NUEVO PEDIDO WEB (JstoreR)*\n`;
                msg += `----------------------------\n`;
                msg += `👤 *Cliente:* ${name}\n`;
                msg += `📍 *Dirección:* ${addr}\n`;
                if(lat && lng) {
                    msg += `🗺️ *GPS:* https://maps.google.com/?q=${lat},${lng}\n`;
                }
                msg += `💳 *Pago:* ${pay}\n`;
                msg += `----------------------------\n`;
                msg += `*DETALLE:*\n`;
                this.cart.forEach(p => msg += `• ${p.name} (S/ ${p.price})\n`);
                const total = this.cart.reduce((a,b)=>a+b.price,0);
                msg += `\n💰 *TOTAL A PAGAR: S/ ${total.toLocaleString()}*`;

                window.open(`https://wa.me/51932508670?text=${encodeURIComponent(msg)}`, '_blank');
            },

            // --- UTILS ---
            setupListeners: function() {
                document.getElementById('search-input').addEventListener('keyup', () => this.renderCatalog());
                document.getElementById('product-modal').addEventListener('click', (e) => {
                   if(e.target === document.getElementById('product-modal')) this.closeModal(); 
                });
            },
            showToast: function(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 3000);
            },
            initGoldDust: function() {
                const cvs = document.getElementById('gold-dust');
                const ctx = cvs.getContext('2d');
                let w, h, p=[];
                const resize = () => { w=cvs.width=window.innerWidth; h=cvs.height=window.innerHeight; };
                const loop = () => {
                    ctx.clearRect(0,0,w,h);
                    ctx.fillStyle = "rgba(212, 175, 55, 0.4)";
                    p.forEach(pt => {
                        ctx.beginPath(); ctx.arc(pt.x, pt.y, pt.r, 0, Math.PI*2); ctx.fill();
                        pt.y -= pt.s; pt.x += Math.sin(pt.y/50)*0.5;
                        if(pt.y < 0) pt.y = h;
                    });
                    requestAnimationFrame(loop);
                };
                resize();
                for(let i=0;i<35;i++) p.push({x:Math.random()*w, y:Math.random()*h, r:Math.random()*2, s:Math.random()*0.5+0.2});
                window.addEventListener('resize', resize);
                loop();
            }
        };

        // START
        document.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>
</html>
