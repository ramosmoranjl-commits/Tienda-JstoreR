<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#fdfaf7">
    <meta name="robots" content="index, follow">
    
    <title>JstoreR · Ultimate Experience</title>
    <meta name="description" content="La experiencia de compra definitiva. Geolocalización satelital, catálogo de lujo y envíos verificados en tiempo real.">
    <meta name="keywords" content="lujo, tienda online, peru, envios, premium, jstorer">
    
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="JstoreR Elite">
    <meta property="og:title" content="JstoreR · Catálogo 2026">
    <meta property="og:description" content="Descubre nuestra colección exclusiva sincronizada en tiempo real.">
    <meta property="og:image" content="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png">
    
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;0,800;0,900;1,400&family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        /* ==========================================================================
           1. CORE DESIGN SYSTEM (CSS VARIABLES & TOKENS)
           ========================================================================== */
        :root {
            /* Paleta "Luxury Ivy" */
            --color-bg-body: #fdfaf7;
            --color-bg-surface: #ffffff;
            --color-bg-glass: rgba(253, 250, 247, 0.85);
            
            --color-text-primary: #111827;
            --color-text-secondary: #64748b;
            --color-text-tertiary: #94a3b8;
            
            --color-accent-gold: #c76a3a;
            --color-accent-gold-hover: #b05a2e;
            --color-accent-green: #10b981;
            --color-accent-green-dark: #059669;
            --color-accent-error: #ef4444;
            
            /* Sombras Elevadas (Depth System) */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
            --shadow-float: 0 20px 50px -12px rgba(199, 106, 58, 0.25);
            
            /* Tipografía */
            --font-display: 'Playfair Display', serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;
            
            /* Animaciones */
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --duration-fast: 200ms;
            --duration-normal: 400ms;
            --duration-slow: 700ms;
            
            /* Layout */
            --container-width: 1400px;
            --header-height: 80px;
            --radius-sm: 8px;
            --radius-md: 16px;
            --radius-lg: 24px;
            --radius-full: 9999px;
            --z-header: 1000;
            --z-modal: 2000;
            --z-toast: 3000;
            --z-cart: 4000;
        }

        /* ==========================================================================
           2. CSS RESET & UTILITIES
           ========================================================================== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--color-bg-body);
            color: var(--color-text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Utilidades de Scroll */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        
        .no-scroll { overflow: hidden !important; }

        /* Typography Utilities */
        h1, h2, h3, h4, h5, h6 { font-family: var(--font-display); font-weight: 700; line-height: 1.2; }
        a { text-decoration: none; color: inherit; transition: var(--duration-fast); }
        button, input, select { font-family: inherit; }
        
        /* ==========================================================================
           3. LAYOUT & HEADER COMPONENTS
           ========================================================================== */
        
        /* Top Announcement Bar */
        .top-bar {
            background: var(--color-text-primary);
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.05em;
            position: relative;
            z-index: var(--z-header);
        }
        .tag-new {
            background: var(--color-accent-gold);
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        /* Main Header Glassmorphism */
        .header-main {
            position: sticky;
            top: 0;
            width: 100%;
            height: var(--header-height);
            background: var(--color-bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            z-index: var(--z-header);
            transition: all var(--duration-normal);
        }
        
        .header-container {
            max-width: var(--container-width);
            height: 100%;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand-logo {
            font-family: var(--font-display);
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--color-accent-gold);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .brand-logo span { color: var(--color-text-primary); }
        .logo-icon { animation: floatLogo 6s ease-in-out infinite; }

        @keyframes floatLogo {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Cart Button Indicator */
        .cart-indicator {
            position: relative;
            background: var(--color-bg-surface);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: transform var(--duration-fast) var(--ease-elastic);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .cart-indicator:hover { transform: scale(1.1) rotate(5deg); box-shadow: var(--shadow-lg); }
        .cart-indicator:active { transform: scale(0.95); }
        
        .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--color-text-primary);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--color-bg-surface);
            animation: bounceIn 0.5s var(--ease-elastic);
        }

        /* ==========================================================================
           4. HERO SECTION & SEARCH
           ========================================================================== */
        .hero {
            padding: 80px 20px 40px;
            text-align: center;
            background: radial-gradient(circle at 50% 0%, rgba(199, 106, 58, 0.08) 0%, transparent 70%);
        }
        
        .hero-title {
            font-size: clamp(2.5rem, 5vw, 4.5rem);
            margin-bottom: 16px;
            opacity: 0;
            transform: translateY(30px);
            animation: fadeInUp 0.8s forwards;
        }
        
        .hero-subtitle {
            font-size: 1.125rem;
            color: var(--color-text-secondary);
            max-width: 600px;
            margin: 0 auto 40px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.8s 0.2s forwards;
        }

        /* Search Dock */
        .search-container {
            position: relative;
            max-width: 600px;
            margin: 0 auto 40px;
            opacity: 0;
            animation: fadeInUp 0.8s 0.4s forwards;
        }
        
        .search-input {
            width: 100%;
            padding: 20px 20px 20px 60px;
            border-radius: 100px;
            border: 2px solid transparent;
            background: var(--color-bg-surface);
            font-size: 1rem;
            box-shadow: var(--shadow-lg);
            transition: all var(--duration-normal);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--color-accent-gold);
            transform: scale(1.02);
            box-shadow: var(--shadow-float);
        }
        
        .search-icon {
            position: absolute;
            left: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-accent-gold);
            font-size: 1.25rem;
            pointer-events: none;
        }

        /* Category Filter Pills */
        .filters-wrapper {
            position: sticky;
            top: var(--header-height);
            z-index: 900;
            background: linear-gradient(180deg, var(--color-bg-body) 0%, rgba(253,250,247,0.95) 80%, transparent 100%);
            padding: 10px 0 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(5px);
        }

        .filters-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 5px 24px;
            justify-content: flex-start;
            max-width: var(--container-width);
            margin: auto;
            /* Ocultar barra scroll pero permitir scroll */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .filters-scroll::-webkit-scrollbar { display: none; }
        
        /* Mascara de desvanecimiento en los bordes */
        .filters-container {
            position: relative;
        }
        .filters-container::after {
            content: '';
            position: absolute;
            right: 0; top: 0; bottom: 0;
            width: 60px;
            background: linear-gradient(to right, transparent, var(--color-bg-body));
            pointer-events: none;
        }

        .filter-pill {
            padding: 10px 24px;
            background: var(--color-bg-surface);
            border: 1px solid #e2e8f0;
            border-radius: 100px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--duration-fast);
            box-shadow: var(--shadow-sm);
        }
        
        .filter-pill:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            color: var(--color-accent-gold);
            border-color: var(--color-accent-gold);
        }
        
        .filter-pill.active {
            background: var(--color-text-primary);
            color: white;
            border-color: var(--color-text-primary);
            box-shadow: var(--shadow-lg);
        }

        /* ==========================================================================
           5. PRODUCT GRID & CARDS
           ========================================================================== */
        .catalog-section {
            padding: 0 24px 100px;
            max-width: var(--container-width);
            margin: 0 auto;
            min-height: 60vh;
        }

        .grid-system {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 32px;
        }

        .card {
            background: var(--color-bg-surface);
            border-radius: var(--radius-lg);
            padding: 16px;
            position: relative;
            transition: all var(--duration-normal) var(--ease-elastic);
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-float);
            z-index: 10;
        }

        .card-image-box {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            border-radius: var(--radius-md);
            overflow: hidden;
            background: #f1f5f9;
            margin-bottom: 16px;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.8s ease;
            mix-blend-mode: multiply; /* Truco para eliminar fondos blancos si la imagen lo tiene */
        }

        .card:hover .card-img { transform: scale(1.1); }

        .card-meta {
            font-size: 0.75rem;
            color: var(--color-accent-gold);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--color-text-primary);
            line-height: 1.4;
            flex-grow: 1; /* Empuja el precio hacia abajo */
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
        }

        .price {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--color-text-primary);
        }

        .btn-add-mini {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--color-text-primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1rem;
        }
        
        .btn-add-mini:hover {
            background: var(--color-accent-gold);
            transform: rotate(90deg);
        }

        /* Loader State */
        .skeleton-loader {
            display: flex; flex-direction: column; gap: 15px;
        }
        .sk-box { background: #e2e8f0; width: 100%; aspect-ratio: 1; border-radius: 16px; animation: pulse 1.5s infinite; }
        .sk-line { height: 20px; background: #e2e8f0; border-radius: 4px; animation: pulse 1.5s infinite; width: 80%; }
        
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* ==========================================================================
           6. CART SIDEBAR & CHECKOUT (MULTI-STEP)
           ========================================================================== */
        .sidebar-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
            z-index: 3999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }
        .sidebar-backdrop.visible { opacity: 1; pointer-events: all; }

        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            max-width: 480px;
            height: 100%;
            background: var(--color-bg-surface);
            z-index: var(--z-cart);
            box-shadow: -20px 0 50px rgba(0,0,0,0.15);
            transition: right 0.5s cubic-bezier(0.7, 0, 0.3, 1);
            display: flex;
            flex-direction: column;
        }
        .sidebar.open { right: 0; }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .sidebar-title { font-size: 1.5rem; font-family: var(--font-display); }
        .btn-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; color: var(--color-text-secondary); transition: 0.3s; }
        .btn-close:hover { transform: rotate(90deg); color: var(--color-accent-error); }

        /* Steps Container */
        .steps-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .step {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 24px;
            overflow-y: auto;
            transition: transform 0.5s ease;
            background: var(--color-bg-surface);
            display: flex;
            flex-direction: column;
        }

        /* Posicionamiento Lógico de Pasos */
        /* Estado por defecto: Paso 1 visible, Paso 2 a la derecha */
        #step-cart { transform: translateX(0); }
        #step-checkout { transform: translateX(100%); }

        /* Estado Checkout: Paso 1 a la izquierda, Paso 2 visible */
        .sidebar[data-step="2"] #step-cart { transform: translateX(-100%); }
        .sidebar[data-step="2"] #step-checkout { transform: translateX(0); }

        /* Cart Items */
        .cart-item {
            display: flex;
            gap: 16px;
            padding: 16px;
            border: 1px solid #f1f5f9;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: 0.3s;
        }
        .cart-item:hover { border-color: #cbd5e1; }
        .cart-img { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; }
        .cart-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .cart-name { font-weight: 700; font-size: 0.95rem; line-height: 1.2; margin-bottom: 4px; }
        .cart-price { color: var(--color-accent-gold); font-weight: 600; }
        .btn-trash {
            background: #fee2e2; color: #ef4444; border: none;
            width: 32px; height: 32px; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            align-self: center;
            transition: 0.2s;
        }
        .btn-trash:hover { background: #ef4444; color: white; }

        /* Checkout Form */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 6px; color: var(--color-text-secondary); }
        .input-field {
            width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 12px;
            font-size: 1rem; transition: 0.3s;
        }
        .input-field:focus { border-color: var(--color-accent-gold); box-shadow: 0 0 0 4px rgba(199, 106, 58, 0.1); outline: none; }

        /* Map Integration */
        .geo-widget {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            margin-bottom: 20px;
        }
        .btn-gps {
            width: 100%;
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            transition: 0.3s;
        }
        .btn-gps:hover { background: #bbf7d0; transform: translateY(-2px); }
        .btn-gps i { animation: pulse 2s infinite; }
        
        #map-canvas {
            height: 0;
            border-radius: 12px;
            overflow: hidden;
            transition: height 0.5s ease;
            margin-bottom: 10px;
        }
        #map-canvas.active { height: 220px; border: 1px solid #e2e8f0; }

        .address-result {
            font-size: 0.9rem;
            color: var(--color-text-primary);
            background: white;
            padding: 10px;
            border-radius: 8px;
            display: none;
            border-left: 3px solid var(--color-accent-gold);
            text-align: left;
        }

        /* Botones de Acción */
        .sidebar-footer {
            margin-top: auto;
            border-top: 1px dashed #e2e8f0;
            padding-top: 20px;
        }
        .total-row { display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 800; margin-bottom: 16px; }
        
        .btn-primary, .btn-whatsapp {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 14px;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-primary { background: var(--color-text-primary); color: white; }
        .btn-primary:hover { background: var(--color-accent-gold); }
        
        .btn-whatsapp { background: var(--color-accent-green); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-whatsapp:hover { background: var(--color-accent-green-dark); transform: scale(1.02); }

        .btn-back {
            background: none; border: none; color: var(--color-text-secondary);
            cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px; font-weight: 600;
        }

        /* ==========================================================================
           7. TOAST NOTIFICATIONS & EXTRAS
           ========================================================================== */
        #toast-container {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: var(--z-toast); display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background: rgba(17, 24, 39, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
            display: flex; align-items: center; gap: 10px;
            backdrop-filter: blur(5px);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Canvas Overlay */
        #gold-dust-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
        }

        /* Error States */
        .error-state {
            text-align: center; padding: 40px; color: var(--color-text-secondary);
            background: #fff; border-radius: 20px; margin: 20px; border: 1px dashed #e2e8f0;
        }

        @media (max-width: 768px) {
            .grid-system { grid-template-columns: repeat(2, 1fr); gap: 16px; }
            .hero-title { font-size: 2.5rem; }
            .card { padding: 12px; }
            .btn-add-mini { width: 36px; height: 36px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <canvas id="gold-dust-canvas"></canvas>
    
    <div id="toast-container"></div>

    <div class="sidebar-backdrop" id="cart-overlay"></div>
    <div class="sidebar" id="cart-sidebar" data-step="1">
        
        <div class="sidebar-header">
            <h2 class="sidebar-title">Tu Bolsa</h2>
            <button class="btn-close" onclick="app.toggleCart()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>

        <div class="steps-wrapper">
            
            <div class="step" id="step-cart">
                <div id="cart-items-wrapper" style="flex:1;">
                    </div>
                
                <div class="sidebar-footer">
                    <div class="total-row">
                        <span>Total</span>
                        <span id="cart-total-display">S/ 0.00</span>
                    </div>
                    <button class="btn-primary" onclick="app.goToCheckout()">
                        Procesar Compra <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <div class="step" id="step-checkout">
                <button class="btn-back" onclick="app.backToStep1()">
                    <i class="fa-solid fa-arrow-left"></i> Volver a productos
                </button>
                
                <h3 style="margin-bottom: 20px; font-size:1.4rem;">Datos de Envío</h3>
                
                <div class="form-group">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" id="input-name" class="input-field" placeholder="Ej. Juan Pérez">
                </div>

                <div class="geo-widget">
                    <label class="form-label">Ubicación de Entrega</label>
                    
                    <button class="btn-gps" onclick="geo.detectLocation()">
                        <i class="fa-solid fa-location-crosshairs"></i> Usar GPS Exacto
                    </button>

                    <div id="map-canvas">
                        <div id="leaflet-map" style="width:100%; height:100%;"></div>
                    </div>

                    <div id="address-box" class="address-result">
                        <strong><i class="fa-solid fa-map-pin"></i> Dirección detectada:</strong><br>
                        <span id="address-text">...</span>
                    </div>

                    <input type="text" id="input-address-manual" class="input-field" placeholder="O escribe tu dirección y referencias..." style="margin-top:10px;">
                </div>

                <div class="form-group">
                    <label class="form-label">Método de Pago</label>
                    <select id="input-payment" class="input-field">
                        <option value="Yape/Plin">Yape o Plin</option>
                        <option value="Transferencia BCP">Transferencia BCP</option>
                        <option value="Contra Entrega">Pago Contra Entrega</option>
                    </select>
                </div>

                <div class="sidebar-footer">
                    <button class="btn-whatsapp" onclick="app.finalizeOrder()">
                        <i class="fa-brands fa-whatsapp" style="font-size:1.3rem;"></i> Confirmar Pedido
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div class="top-bar">
        <span class="tag-new">NUEVO</span> ENVÍOS GRATIS A TODO EL PERÚ POR COMPRAS MAYORES A S/ 200
    </div>

    <header class="header-main">
        <div class="header-container">
            <a href="#" class="brand-logo">
                <i class="fa-solid fa-gem logo-icon"></i> JSTORE<span>R</span>
            </a>
            
            <div class="cart-indicator" onclick="app.toggleCart()">
                <i class="fa-solid fa-bag-shopping"></i>
                <div class="badge" id="cart-badge-count">0</div>
            </div>
        </div>
    </header>

    <section class="hero">
        <h1 class="hero-title">Elite Selection <span style="color:var(--color-accent-gold);">2026</span></h1>
        <p class="hero-subtitle">Ingeniería de lujo al alcance de un clic. Catálogo sincronizado en tiempo real.</p>
        
        <div class="search-container">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input type="text" class="search-input" placeholder="Buscar Rolex, iPhone, Carteras..." onkeyup="app.handleSearch(this.value)">
        </div>
    </section>

    <div class="filters-container">
        <div class="filters-wrapper">
            <div class="filters-scroll" id="filters-mount">
                <div class="skeleton-loader" style="flex-direction:row; gap:10px;">
                    <div class="sk-line" style="width:80px; height:35px; border-radius:20px;"></div>
                    <div class="sk-line" style="width:100px; height:35px; border-radius:20px;"></div>
                    <div class="sk-line" style="width:90px; height:35px; border-radius:20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <main class="catalog-section">
        <div class="grid-system" id="catalog-mount">
            <div class="skeleton-loader"><div class="sk-box"></div><div class="sk-line"></div><div class="sk-line" style="width:40%;"></div></div>
            <div class="skeleton-loader"><div class="sk-box"></div><div class="sk-line"></div><div class="sk-line" style="width:40%;"></div></div>
            <div class="skeleton-loader"><div class="sk-box"></div><div class="sk-line"></div><div class="sk-line" style="width:40%;"></div></div>
            <div class="skeleton-loader"><div class="sk-box"></div><div class="sk-line"></div><div class="sk-line" style="width:40%;"></div></div>
        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        /**
         * ============================================================================
         * JSTORE-R KERNEL V3.0 (PURE JS MONOLITH)
         * ============================================================================
         */

        // --- CONFIGURACIÓN DEL SISTEMA (EDITAR AQUÍ) ---
        const CONFIG = {
            // ¡IMPORTANTE! Reemplaza esto con el enlace CSV de tu Google Sheet
            // Pasos: Archivo > Compartir > Publicar en la web > Selecciona hoja > Formato CSV
            sheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOKWE4Wyh_N_pt12iDlXx_garwZHFKRcE19DRoKSa2Cb_v3KoSmcQcJXRS2MdrfB7Bso-DqSXdINSt/pub?gid=0&single=true&output=csv", 
            
            currencySymbol: "S/",
            whatsappNumber: "51932508670", // Tu número
            defaultLocation: { lat: -12.046374, lng: -77.042793 }, // Lima Centro
            
            // Mapeo de columnas de tu Google Sheet (Ajustar según tus cabeceras reales)
            // El script buscará columnas que contengan estos nombres (case insensitive)
            colMap: {
                id: ["id", "sku", "codigo"],
                name: ["nombre", "producto", "titulo", "name"],
                price: ["precio", "price", "valor", "costo"],
                category: ["categoria", "tipo", "category"],
                image: ["imagen", "foto", "img", "image", "url"],
                description: ["descripcion", "desc", "detalle"]
            }
        };

        // --- MÓDULO 1: UTILIDADES & HELPERS ---
        const Utils = {
            formatMoney: (amount) => {
                return `${CONFIG.currencySymbol} ${parseFloat(amount).toFixed(2)}`;
            },
            
            // Parseador CSV Robusto (Maneja comas dentro de comillas)
            parseCSV: (str) => {
                const arr = [];
                let quote = false;  // 'true' means we're inside a quoted field
                let col, c;

                for (let row = 0, col = 0, c = 0; c < str.length; c++) {
                    let cc = str[c], nc = str[c+1];
                    arr[row] = arr[row] || [];
                    arr[row][col] = arr[row][col] || '';

                    if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }
                    if (cc == '"') { quote = !quote; continue; }
                    if (cc == ',' && !quote) { ++col; continue; }
                    if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }
                    if (cc == '\n' && !quote) { ++row; col = 0; continue; }
                    if (cc == '\r' && !quote) { ++row; col = 0; continue; }

                    arr[row][col] += cc;
                }
                return arr;
            },

            // Sistema de Notificaciones (Toasts)
            toast: (msg, type = 'info') => {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = 'toast';
                
                let icon = type === 'success' ? '<i class="fa-solid fa-check-circle" style="color:#4ade80"></i>' : 
                           type === 'error' ? '<i class="fa-solid fa-circle-exclamation" style="color:#f87171"></i>' : 
                           '<i class="fa-solid fa-info-circle"></i>';
                
                el.innerHTML = `${icon} <span>${msg}</span>`;
                container.appendChild(el);
                
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(20px)';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            }
        };

        // --- MÓDULO 2: GESTOR DE DATOS (GOOGLE SHEETS) ---
        class DataService {
            constructor() {
                this.products = [];
                this.categories = [];
            }

            async fetchProducts() {
                if (CONFIG.sheetUrl.includes("PEGAR_AQUI")) {
                    Utils.toast("⚠️ Error: Configura la URL de Google Sheets en el código.", "error");
                    this.loadDemoData(); // Fallback para que no se vea vacío mientras configuras
                    return;
                }

                try {
                    const response = await fetch(CONFIG.sheetUrl);
                    if (!response.ok) throw new Error("Error de red");
                    const csvText = await response.text();
                    this.processCSV(csvText);
                } catch (error) {
                    console.error("Fallo al cargar Sheet:", error);
                    Utils.toast("Error cargando catálogo. Usando datos demo.", "error");
                    this.loadDemoData();
                }
            }

            processCSV(csvText) {
                const rawData = Utils.parseCSV(csvText);
                if (rawData.length < 2) return;

                const headers = rawData[0].map(h => h.toLowerCase().trim());
                const rows = rawData.slice(1);

                // Detectar índices de columnas dinámicamente
                const getIdx = (keys) => headers.findIndex(h => keys.some(k => h.includes(k)));
                
                const idx = {
                    id: getIdx(CONFIG.colMap.id),
                    name: getIdx(CONFIG.colMap.name),
                    price: getIdx(CONFIG.colMap.price),
                    cat: getIdx(CONFIG.colMap.category),
                    img: getIdx(CONFIG.colMap.image)
                };

                // Validar que encontramos lo mínimo necesario
                if (idx.name === -1 || idx.price === -1) {
                    console.error("No se encontraron columnas clave en el CSV");
                    return;
                }

                this.products = rows.map((row, i) => {
                    // Limpieza de precio (quitar símbolos de moneda si existen en el sheet)
                    let rawPrice = row[idx.price] || "0";
                    let priceClean = parseFloat(rawPrice.replace(/[^0-9.]/g, ''));

                    return {
                        id: (idx.id !== -1 && row[idx.id]) ? row[idx.id] : `GEN-${i}`,
                        name: row[idx.name] || "Producto sin nombre",
                        price: isNaN(priceClean) ? 0 : priceClean,
                        category: (idx.cat !== -1 && row[idx.cat]) ? row[idx.cat] : "Varios",
                        image: (idx.img !== -1 && row[idx.img]) ? row[idx.img] : "https://via.placeholder.com/400x400?text=No+Image"
                    };
                }).filter(p => p.name !== "Producto sin nombre" && p.price > 0);

                this.extractCategories();
                app.renderCatalog();
            }

            extractCategories() {
                const cats = new Set(this.products.map(p => p.category));
                this.categories = ["Todos", ...Array.from(cats)];
                app.renderFilters();
            }

            // Datos de respaldo por si falla el Sheet o no está configurado
            loadDemoData() {
                this.products = [
                    { id: 1, name: "Demo: Rolex Submariner", price: 45000, category: "Relojes", image: "https://images.unsplash.com/photo-1523170335258-f5ed11844a49?auto=format&fit=crop&w=600" },
                    { id: 2, name: "Demo: MacBook Pro M3", price: 12000, category: "Tech", image: "https://images.unsplash.com/photo-1517336714731-489689fd1ca4?auto=format&fit=crop&w=600" },
                    { id: 3, name: "Demo: Louis Vuitton Bag", price: 8500, category: "Moda", image: "https://images.unsplash.com/photo-1548036328-c9fa89d128fa?auto=format&fit=crop&w=600" },
                ];
                this.extractCategories();
                app.renderCatalog();
            }
        }

        // --- MÓDULO 3: GEOLOCALIZACIÓN (LEAFLET ENGINE) ---
        class GeoEngine {
            constructor() {
                this.map = null;
                this.marker = null;
                this.lat = null;
                this.lng = null;
                this.googleMapsLink = "";
            }

            initMap() {
                if (this.map) return; // Ya existe

                this.map = L.map('leaflet-map').setView([CONFIG.defaultLocation.lat, CONFIG.defaultLocation.lng], 13);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(this.map);

                // Icono customizado (opcional, usando default por ahora)
                this.marker = L.marker([CONFIG.defaultLocation.lat, CONFIG.defaultLocation.lng], {
                    draggable: true
                }).addTo(this.map);

                // Listener: Al arrastrar manual
                this.marker.on('dragend', (e) => {
                    const pos = e.target.getLatLng();
                    this.updateCoords(pos.lat, pos.lng, true);
                });
            }

            detectLocation() {
                const btn = document.querySelector('.btn-gps');
                const mapContainer = document.getElementById('map-canvas');
                
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Conectando Satélite...';
                
                // Mostrar mapa visualmente
                mapContainer.classList.add('active');
                
                // Hack para Leaflet: invalidar tamaño tras la transición CSS para evitar mapa gris
                setTimeout(() => {
                    if (!this.map) this.initMap();
                    this.map.invalidateSize();
                }, 400);

                if (!navigator.geolocation) {
                    Utils.toast("Tu navegador no soporta GPS", "error");
                    btn.innerHTML = 'Error de soporte';
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        this.updateCoords(latitude, longitude);
                        
                        btn.innerHTML = '<i class="fa-solid fa-check-double"></i> Ubicación Exacta';
                        btn.style.background = "#bbf7d0";
                    },
                    (error) => {
                        console.error(error);
                        Utils.toast("Permiso de ubicación denegado. Mueve el pin manualmente.", "info");
                        btn.innerHTML = 'Usar mapa manual';
                        
                        // Centrar en default
                        if (!this.map) this.initMap();
                        this.updateCoords(CONFIG.defaultLocation.lat, CONFIG.defaultLocation.lng);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }

            updateCoords(lat, lng, isDrag = false) {
                this.lat = lat;
                this.lng = lng;
                this.googleMapsLink = `https://www.google.com/maps?q=${lat},${lng}`;

                if (!isDrag && this.map) {
                    this.map.setView([lat, lng], 16);
                    this.marker.setLatLng([lat, lng]);
                }

                // Reverse Geocoding (Lat/Lng -> Texto)
                fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
                    .then(r => r.json())
                    .then(data => {
                        const address = data.display_name;
                        document.getElementById('address-box').style.display = 'block';
                        document.getElementById('address-text').innerText = address;
                        
                        // Rellenar input manual también por si acaso
                        document.getElementById('input-address-manual').value = address;
                    })
                    .catch(() => {
                        document.getElementById('address-text').innerText = "Ubicación fijada en mapa (Sin dirección postal detectada)";
                    });
            }
        }

        // --- MÓDULO 4: LÓGICA DE APLICACIÓN (APP CONTROLLER) ---
        class App {
            constructor() {
                this.cart = JSON.parse(localStorage.getItem('jstorer_cart')) || [];
                this.dataService = new DataService();
                this.geo = new GeoEngine();
                this.currentFilter = 'Todos';
            }

            init() {
                this.dataService.fetchProducts();
                this.updateCartUI();
                this.initVisuals();
                
                // Event Listeners Globales
                document.getElementById('cart-overlay').addEventListener('click', () => this.toggleCart(false));
            }

            // -- RENDERIZADO --
            renderFilters() {
                const container = document.getElementById('filters-mount');
                container.innerHTML = this.dataService.categories.map(cat => `
                    <div class="filter-pill ${cat === 'Todos' ? 'active' : ''}" 
                         onclick="app.setFilter('${cat}', this)">
                        ${cat}
                    </div>
                `).join('');
            }

            renderCatalog(products = null) {
                const list = products || this.dataService.products;
                const container = document.getElementById('catalog-mount');
                
                if (list.length === 0) {
                    container.innerHTML = `
                        <div class="error-state" style="grid-column: 1/-1;">
                            <i class="fa-regular fa-folder-open" style="font-size:3rem; margin-bottom:15px; opacity:0.3;"></i>
                            <h3>No se encontraron productos</h3>
                            <p>Intenta con otro término de búsqueda.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = list.map(p => `
                    <article class="card">
                        <div class="card-image-box">
                            <img src="${p.image}" alt="${p.name}" class="card-img" loading="lazy" onerror="this.src='https://via.placeholder.com/400?text=JStoreR'">
                        </div>
                        <div class="card-meta">${p.category}</div>
                        <h3 class="card-title">${p.name}</h3>
                        <div class="card-footer">
                            <span class="price">${Utils.formatMoney(p.price)}</span>
                            <button class="btn-add-mini" onclick="app.addToCart('${p.id}')">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </article>
                `).join('');
            }

            // -- LÓGICA DE FILTRADO --
            setFilter(category, element) {
                this.currentFilter = category;
                
                // Actualizar UI Pills
                document.querySelectorAll('.filter-pill').forEach(el => el.classList.remove('active'));
                element.classList.add('active');

                // Filtrar datos
                if (category === 'Todos') {
                    this.renderCatalog(this.dataService.products);
                } else {
                    const filtered = this.dataService.products.filter(p => p.category === category);
                    this.renderCatalog(filtered);
                }
            }

            handleSearch(query) {
                const q = query.toLowerCase();
                const filtered = this.dataService.products.filter(p => 
                    p.name.toLowerCase().includes(q) || 
                    p.category.toLowerCase().includes(q)
                );
                this.renderCatalog(filtered);
            }

            // -- LÓGICA DE CARRITO --
            addToCart(id) {
                const product = this.dataService.products.find(p => p.id == id);
                if (!product) return;

                this.cart.push(product);
                this.saveCart();
                this.updateCartUI();
                Utils.toast(`Agregado: ${product.name}`, "success");
                
                // Pequeña animación en el icono del carrito
                const badge = document.querySelector('.cart-indicator');
                badge.style.transform = 'scale(1.3)';
                setTimeout(() => badge.style.transform = 'scale(1)', 200);
            }

            removeFromCart(index) {
                this.cart.splice(index, 1);
                this.saveCart();
                this.updateCartUI();
            }

            saveCart() {
                localStorage.setItem('jstorer_cart', JSON.stringify(this.cart));
            }

            updateCartUI() {
                // Badge Header
                const badge = document.getElementById('cart-badge-count');
                badge.innerText = this.cart.length;
                badge.style.display = this.cart.length > 0 ? 'flex' : 'none';

                // Lista Sidebar
                const container = document.getElementById('cart-items-wrapper');
                const totalEl = document.getElementById('cart-total-display');
                
                const total = this.cart.reduce((sum, item) => sum + item.price, 0);
                totalEl.innerText = Utils.formatMoney(total);

                if (this.cart.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:40px 0; opacity:0.5;">
                            <i class="fa-solid fa-bag-shopping" style="font-size:3rem; margin-bottom:10px;"></i>
                            <p>Tu bolsa está vacía</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = this.cart.map((item, i) => `
                        <div class="cart-item">
                            <img src="${item.image}" class="cart-img">
                            <div class="cart-info">
                                <div class="cart-name">${item.name}</div>
                                <div class="cart-price">${Utils.formatMoney(item.price)}</div>
                            </div>
                            <button class="btn-trash" onclick="app.removeFromCart(${i})">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                }
            }

            toggleCart(state = null) {
                const sidebar = document.getElementById('cart-sidebar');
                const overlay = document.getElementById('cart-overlay');
                const isOpen = sidebar.classList.contains('open');
                
                const nextState = state !== null ? state : !isOpen;

                if (nextState) {
                    sidebar.classList.add('open');
                    overlay.classList.add('visible');
                } else {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('visible');
                    // Resetear pasos al cerrar
                    setTimeout(() => this.backToStep1(), 500);
                }
            }

            // -- CHECKOUT FLOW --
            goToCheckout() {
                if (this.cart.length === 0) return Utils.toast("Agrega productos primero", "error");
                
                const sidebar = document.getElementById('cart-sidebar');
                sidebar.setAttribute('data-step', '2');
                
                // Iniciar mapa (delay pequeño para permitir renderizado del DOM)
                setTimeout(() => this.geo.initMap(), 100);
            }

            backToStep1() {
                document.getElementById('cart-sidebar').setAttribute('data-step', '1');
            }

            finalizeOrder() {
                const name = document.getElementById('input-name').value;
                const address = document.getElementById('input-address-manual').value;
                const payment = document.getElementById('input-payment').value;

                if (!name || !address) {
                    Utils.toast("Por favor completa Nombre y Dirección", "error");
                    // Highlight inputs
                    if(!name) document.getElementById('input-name').focus();
                    else document.getElementById('input-address-manual').focus();
                    return;
                }

                // Construcción del Mensaje (Formato Profesional)
                let msg = `*NUEVO PEDIDO WEB · JSTORE-R ELITE*\n`;
                msg += `──────────────────────────\n`;
                msg += `👤 *Cliente:* ${name}\n`;
                msg += `💳 *Método Pago:* ${payment}\n`;
                msg += `📍 *Dirección Escrita:* ${address}\n`;
                
                if (this.geo.googleMapsLink) {
                    msg += `🗺️ *GPS Exacto:* ${this.geo.googleMapsLink}\n`;
                }
                
                msg += `──────────────────────────\n`;
                msg += `*DETALLE DEL PEDIDO:*\n`;
                
                this.cart.forEach(item => {
                    msg += `▪ ${item.name} (${Utils.formatMoney(item.price)})\n`;
                });

                const total = this.cart.reduce((s, i) => s + i.price, 0);
                msg += `\n💰 *TOTAL FINAL: ${Utils.formatMoney(total)}*\n`;
                msg += `──────────────────────────`;

                // Enviar
                const url = `https://wa.me/${CONFIG.whatsappNumber}?text=${encodeURIComponent(msg)}`;
                window.open(url, '_blank');
                
                // Limpiar carrito post-compra
                this.cart = [];
                this.saveCart();
                this.updateCartUI();
                this.toggleCart(false);
                Utils.toast("¡Pedido enviado a WhatsApp!", "success");
            }

            // -- VISUALS (Gold Dust Canvas) --
            initVisuals() {
                const canvas = document.getElementById('gold-dust-canvas');
                const ctx = canvas.getContext('2d');
                let w, h, particles = [];

                const resize = () => {
                    w = canvas.width = window.innerWidth;
                    h = canvas.height = window.innerHeight;
                };

                const createParticles = () => {
                    particles = [];
                    // Cantidad de partículas basada en ancho de pantalla
                    const count = w < 768 ? 20 : 45; 
                    for(let i=0; i<count; i++) {
                        particles.push({
                            x: Math.random() * w,
                            y: Math.random() * h,
                            r: Math.random() * 2, // Radio
                            dy: Math.random() * 0.5 + 0.1, // Velocidad Y
                            dx: Math.random() * 0.4 - 0.2 // Oscilación X
                        });
                    }
                };

                const animate = () => {
                    ctx.clearRect(0,0,w,h);
                    ctx.fillStyle = "rgba(199, 106, 58, 0.35)"; // Color Gold con transparencia
                    
                    particles.forEach(p => {
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                        ctx.fill();
                        
                        p.y -= p.dy; // Movimiento hacia arriba (Dust effect)
                        p.x += p.dx;
                        
                        // Reset si sale de pantalla
                        if(p.y < 0) p.y = h;
                        if(p.x > w) p.x = 0;
                        if(p.x < 0) p.x = w;
                    });
                    
                    requestAnimationFrame(animate);
                };

                window.addEventListener('resize', () => { resize(); createParticles(); });
                resize();
                createParticles();
                animate();
            }
        }

        // --- INICIALIZACIÓN ---
        const app = new App();
        const geo = app.geo; // Acceso directo para el HTML onclick
        
        // Arrancar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
