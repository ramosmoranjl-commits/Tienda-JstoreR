<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#111827">
    
    <title>JstoreR · Tienda Oficial</title>
    <meta name="description" content="Galería exclusiva de artículos. Envíos seguros y verificados a todo el Perú.">
    
    <meta property="og:type" content="website">
    <meta property="og:title" content="JstoreR · Catálogo 2026">
    <meta property="og:image" content="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png">
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;0,800;0,900;1,700&family=Plus+Jakarta+Sans:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ==========================================================================
           JSTORER DESIGN SYSTEM V24.0 - GPS MAP EDITION
           ========================================================================== */
        :root {
            --jst-bg-ivory: #fdfaf7; --jst-accent-gold: #c76a3a; --jst-onyx: #111827;
            --jst-slate: #64748b; --jst-white: #ffffff; --jst-whatsapp: #25d366;
            --font-main: 'Plus Jakarta Sans', sans-serif; --font-accent: 'Playfair Display', serif;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-main); background-color: var(--jst-bg-ivory); color: var(--jst-onyx); overflow-x: hidden; min-height: 100vh; display: flex; flex-direction: column; }

        /* TOP BAR & HEADER */
        .top-announcement-bar { background: var(--jst-onyx); color: white; text-align: center; padding: 10px; font-size: 0.8rem; font-weight: 600; position: relative; z-index: 5001; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .header-master { position: sticky; top: 0; z-index: 5000; background: rgba(253, 250, 247, 0.92); backdrop-filter: blur(25px); border-bottom: 1px solid rgba(199, 106, 58, 0.1); }
        .nav-container { max-width: 1440px; margin: auto; display: flex; align-items: center; justify-content: space-between; padding: 1rem 2rem; }
        .logo-img { height: 60px; }
        .cart-trigger { position: relative; cursor: pointer; background: var(--jst-white); padding: 14px; border-radius: 50%; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); }
        .badge-count { position: absolute; top: -5px; right: -5px; background: var(--jst-onyx); color: white; min-width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 800; }

        /* HERO & CONTENT */
        .hero-v10 { padding: 6rem 2rem 2rem; text-align: center; max-width: 1100px; margin: auto; }
        .hero-v10 h1 { font-family: var(--font-accent); font-size: clamp(2.5rem, 8vw, 4.5rem); margin-bottom: 1.5rem; }
        .search-wrapper { position: relative; max-width: 700px; margin: 3rem auto 1.5rem; }
        .search-input { width: 100%; padding: 24px 30px 24px 70px; border-radius: 100px; border: 1px solid rgba(0,0,0,0.06); font-size: 1.1rem; }
        .search-icon { position: absolute; left: 30px; top: 50%; transform: translateY(-50%); color: var(--jst-accent-gold); font-size: 1.4rem; }
        
        /* CATALOG GRID */
        .catalog-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 40px; padding: 2rem; max-width: 1440px; margin: auto; flex: 1; }
        .card-item { background: white; border-radius: 28px; padding: 20px; border: 1px solid rgba(0,0,0,0.02); transition: 0.6s; display: flex; flex-direction: column; position: relative; }
        .card-img-container { width: 100%; aspect-ratio: 1; border-radius: 20px; overflow: hidden; background: #f8fafc; margin-bottom: 20px; cursor: pointer; }
        .card-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .price-tag { font-weight: 900; font-size: 1.6rem; color: var(--jst-onyx); }
        .btn-add { background: var(--jst-accent-gold); color: white; border: none; width: 54px; height: 54px; border-radius: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        /* NUEVO: MAPA INTERACTIVO (Del archivo pequeño) */
        #map-container { 
            height: 0; 
            width: 100%; 
            margin-bottom: 15px; 
            border-radius: 15px; 
            overflow: hidden; 
            border: 1px solid #e2e8f0; 
            transition: height 0.5s ease; 
        }
        #map { height: 100%; width: 100%; }
        .map-visible { height: 250px !important; }

        /* CARRITO & SIDEBAR */
        .side-cart { position: fixed; right: -100%; top: 0; width: 100%; max-width: 500px; height: 100%; background: var(--jst-white); z-index: 6000; transition: 0.6s cubic-bezier(0.19, 1, 0.22, 1); display: flex; flex-direction: column; }
        .side-cart.open { right: 0; }
        .cart-step { min-width: 100%; height: 100%; overflow-y: auto; padding: 2rem; transition: transform 0.5s; display: flex; flex-direction: column; }
        .side-cart.step-2 .cart-step { transform: translateX(-100%); }
        .premium-input { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid #e2e8f0; font-family: inherit; margin-bottom: 15px; }
        .btn-wa-final { width: 100%; padding: 22px; background: var(--jst-whatsapp); color: white; border: none; border-radius: 20px; font-weight: 800; cursor: pointer; opacity: 0.5; pointer-events: none; }
        .btn-wa-final.active { opacity: 1; pointer-events: auto; }

        /* FAQ */
        .faq-container { max-width: 800px; margin: 4rem auto; padding: 0 2rem; }
        .faq-item { background: white; border-radius: 15px; margin-bottom: 10px; border: 1px solid #f1f5f9; }
        .faq-question { padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .faq-answer { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; padding: 0 20px; color: var(--jst-slate); }
        .faq-item.active .faq-answer { max-height: 200px; padding-bottom: 20px; }

        @media (max-width: 768px) {
            .catalog-container { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 1rem; }
            .card-info p { display: none; }
        }
    </style>
</head>
<body>

    <canvas id="gold-dust-layer" style="position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:5; opacity:0.3;"></canvas>

    <div class="top-announcement-bar">
        <span style="background:var(--jst-accent-gold); padding:2px 8px; border-radius:4px; font-size:0.7rem;">OFERTA</span>
        <span>Envíos GRATIS a partir de S/ 500</span>
    </div>

    <header class="header-master">
        <nav class="nav-container">
            <a href="#" class="logo-box" style="text-decoration:none; color:inherit; display:flex; align-items:center; gap:10px;">
                <img src="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png" class="logo-img">
                <div>
                    <span style="display:block; font-family:var(--font-accent); font-weight:900; font-size:1.6rem;">JstoreR</span>
                    <span style="font-size:0.6rem; text-transform:uppercase; letter-spacing:3px; color:var(--jst-accent-gold); font-weight:800;">Tienda Oficial</span>
                </div>
            </a>
            <div class="cart-trigger" onclick="toggleCart(true)">
                <i class="fas fa-shopping-bag"></i>
                <span id="cart-badge" class="badge-count" style="display:none;">0</span>
            </div>
        </nav>
    </header>

    <main>
        <section class="hero-v10">
            <div style="display:inline-block; border:1px solid var(--jst-accent-gold); padding:5px 15px; border-radius:50px; margin-bottom:1rem; color:var(--jst-accent-gold); font-weight:700; font-size:0.8rem;">
                <i class="fas fa-clock"></i> Stock Disponible por Tiempo Limitado
            </div>
            <h1>Date el gusto que mereces</h1>
            <div class="search-wrapper"><i class="fas fa-search search-icon"></i><input type="text" id="master-search" class="search-input" placeholder="¿Qué buscas hoy?" oninput="handleSmartFilter()"></div>
        </section>

        <div class="catalog-container" id="main-grid"></div>

        <section class="faq-container">
            <h2 style="font-family:var(--font-accent); text-align:center; margin-bottom:2rem;">Preguntas Frecuentes</h2>
            <div class="faq-item" onclick="this.classList.toggle('active')">
                <div class="faq-question">¿Cómo realizo el pago? <i class="fas fa-chevron-down"></i></div>
                <div class="faq-answer">Aceptamos transferencias BCP, Interbank, BBVA y Yape/Plin. El pago se coordina por WhatsApp tras confirmar el stock.</div>
            </div>
            <div class="faq-item" onclick="this.classList.toggle('active')">
                <div class="faq-question">¿Es seguro el envío por GPS? <i class="fas fa-chevron-down"></i></div>
                <div class="faq-answer">Totalmente. El sistema calcula los KM reales desde nuestro almacén en Jr. Cuzco 626 para darte una tarifa de delivery 100% transparente.</div>
            </div>
        </section>

        <footer style="background: white; border-top: 1px solid #f1f5f9; padding: 4rem 2rem 2rem; text-align: center;">
            <div style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:15px;">
                <img src="https://res.cloudinary.com/djpp4pwh8/image/upload/v1768128894/1001127115_kxjcfn.png" style="height:40px;">
                <span style="font-family:var(--font-accent); font-weight:900; font-size:1.4rem;">JstoreR</span>
            </div>
            <p style="color:var(--jst-slate); font-size:0.9rem;">&copy; 2026 JstoreR. Tu compra segura en todo el Perú.</p>
        </footer>
    </main>

    <aside class="side-cart" id="side-cart">
        <div class="cart-header" style="display:flex; justify-content:space-between; align-items:center; padding:2rem; border-bottom:1px solid #eee;">
            <h2 id="cart-title" style="font-family:var(--font-accent); margin:0;">Tu Selección</h2>
            <div onclick="toggleCart(false)" style="cursor:pointer; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; background:#f1f5f9;"><i class="fas fa-times"></i></div>
        </div>

        <div class="cart-views-container">
            <div class="cart-step" id="step-1">
                <div id="cart-items-list" style="flex:1;"></div>
                <div style="margin-top:auto; padding-top:2rem;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:800; font-size:1.2rem;"><span>Subtotal:</span><span id="step1-total">S/ 0.00</span></div>
                    <button style="width:100%; padding:20px; background:var(--jst-onyx); color:white; border:none; border-radius:18px; font-weight:800; cursor:pointer;" onclick="goToStep(2)">Continuar Pedido</button>
                </div>
            </div>

            <div class="cart-step" id="step-2">
                <button onclick="goToStep(1)" style="background:none; border:none; font-weight:700; color:var(--jst-slate); cursor:pointer; margin-bottom:1rem;"><i class="fas fa-arrow-left"></i> Volver</button>
                <h3 style="font-family:var(--font-accent); margin-bottom:1rem;">Entrega Inteligente</h3>
                
                <input type="text" id="form-name" class="premium-input" placeholder="Tu nombre" oninput="validateForm()">
                <input type="tel" id="form-phone" class="premium-input" placeholder="Celular" oninput="validateForm()">
                
                <div id="map-container">
                    <div id="map"></div>
                </div>

                <div style="position:relative; margin-bottom:5px;">
                    <input type="text" id="form-address" class="premium-input" placeholder="Dirección exacta" oninput="validateForm()">
                    <button onclick="calculateGPSDistance()" style="position:absolute; right:10px; top:18px; border:none; background:none; color:var(--jst-accent-gold); cursor:pointer; font-size:1.3rem;">
                        <i class="fas fa-map-marker-alt" id="gps-icon-btn"></i>
                    </button>
                </div>
                
                <div id="gps-status-msg" style="font-size:0.75rem; color:#94a3b8; margin-bottom:15px; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-info-circle"></i> Pulsa el GPS para calcular el envío automático.
                </div>

                <input type="hidden" id="form-km"> <div style="background:#fffbf7; padding:15px; border-radius:15px; border:1px dashed var(--jst-accent-gold); margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#64748b;"><span>Productos:</span><span id="final-subtotal">S/ 0.00</span></div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#64748b;"><span>Delivery (KM):</span><span id="final-shipping">...</span></div>
                    <div style="display:flex; justify-content:space-between; font-weight:900; font-size:1.4rem; border-top:1px solid #ddd; padding-top:10px; color:var(--jst-accent-gold);"><span>TOTAL:</span><span id="final-total">S/ 0.00</span></div>
                </div>

                <button id="btn-wa" class="btn-wa-final" onclick="launchCelebration()">Confirmar Pedido por WhatsApp</button>
            </div>
        </div>
    </aside>

    <div id="celebration-modal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:7000; display:none; flex-direction:column; align-items:center; justify-content:center;">
        <i class="fas fa-check-circle" style="font-size:4rem; color:#10b981; margin-bottom:1rem;"></i>
        <h2 style="font-family:var(--font-accent);">¡Excelente!</h2>
        <p>Procesando pedido...</p>
    </div>

    <script>
        // CONFIGURACIÓN GLOBAL
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOKWE4Wyh_N_pt12iDlXx_garwZHFKRcE19DRoKSa2Cb_v3KoSmcQcJXRS2MdrfB7Bso-DqSXdINSt/pub?gid=0&single=true&output=csv";
        const STORE_LOC = { lat: -12.053850, lng: -77.031550 }; 
        
        let CATALOG = [];
        let state_cart = JSON.parse(localStorage.getItem('jst_master_cart')) || [];
        let map, userMarker, accuracyCircle;

        window.onload = async () => {
            initGoldDust();
            await fetchProducts();
            refreshCartUI();
        };

        async function fetchProducts() {
            try {
                const res = await fetch(SHEET_URL);
                const csv = await res.text();
                CATALOG = parseCSV(csv);
                renderCatalog();
            } catch (e) { console.error("Error cargando Excel", e); }
        }

        function parseCSV(text) {
            const rows = text.split('\n').slice(1);
            return rows.map(r => {
                const p = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const clean = (t) => t ? t.replace(/^"|"$/g, '').trim() : '';
                return { id: clean(p[0]), name: clean(p[1]), cat: clean(p[2]), price: parseFloat(clean(p[3]).replace(/[^\d.]/g,'')), img: clean(p[4]), desc: clean(p[5]), stock: parseInt(clean(p[6])) };
            }).filter(p => !isNaN(p.price));
        }

        function renderCatalog() {
            const grid = document.getElementById('main-grid');
            grid.innerHTML = CATALOG.map(p => `
                <article class="card-item">
                    <div class="card-img-container" onclick="addItemToCart('${p.id}')">
                        <img src="${p.img}" alt="${p.name}">
                    </div>
                    <div style="flex:1;">
                        <span style="font-size:0.65rem; color:var(--jst-accent-gold); font-weight:800;">${p.cat}</span>
                        <h3 style="font-size:1.1rem; margin:5px 0;">${p.name}</h3>
                        <p style="font-size:0.8rem; color:var(--jst-slate);">${p.desc}</p>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-top:15px;">
                        <span class="price-tag">S/ ${p.price.toFixed(2)}</span>
                        <button class="btn-add" onclick="addItemToCart('${p.id}')"><i class="fas fa-plus"></i></button>
                    </div>
                </article>
            `).join('');
        }

        // --- SISTEMA GPS Y MAPA PROFESIONAL (Fusión de ambos archivos) ---
        function calculateGPSDistance() {
            const btn = document.getElementById('gps-icon-btn');
            const msg = document.getElementById('gps-status-msg');

            if (!navigator.geolocation) return alert("GPS no disponible");

            btn.className = "fas fa-spinner fa-spin";
            msg.innerText = "Obteniendo ubicación precisa...";

            navigator.geolocation.getCurrentPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const acc = position.coords.accuracy;

                // 1. Mostrar Mapa
                document.getElementById('map-container').classList.add('map-visible');
                setTimeout(() => initLeafletMap(lat, lng, acc), 500);

                // 2. Calcular Distancia
                const dist = getDistKm(STORE_LOC.lat, STORE_LOC.LOC, lat, lng);
                document.getElementById('form-km').value = dist.toFixed(1);
                
                // 3. Obtener Dirección (Reverse Geocoding)
                fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`)
                    .then(r => r.json())
                    .then(data => {
                        document.getElementById('form-address').value = data.display_name.split(',').slice(0,3).join(',');
                        btn.className = "fas fa-check-circle";
                        btn.style.color = "#10b981";
                        msg.innerHTML = `<span style="color:#10b981">📍 Ubicación Verificada (Error: ${Math.round(acc)}m)</span>`;
                        refreshSummary();
                    });

            }, () => {
                alert("Activa el GPS");
                btn.className = "fas fa-map-marker-alt";
            }, { enableHighAccuracy: true });
        }

        function initLeafletMap(lat, lng, acc) {
            if (!map) {
                map = L.map('map').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                userMarker = L.marker([lat, lng]).addTo(map);
                accuracyCircle = L.circle([lat, lng], { radius: acc }).addTo(map);
            } else {
                map.setView([lat, lng], 16);
                userMarker.setLatLng([lat, lng]);
                accuracyCircle.setLatLng([lat, lng]).setRadius(acc);
            }
        }

        function getDistKm(la1, lo1, la2, lo2) {
            const R = 6371;
            const dLa = (la2-la1)*(Math.PI/180);
            const dLo = (lo2-lo1)*(Math.PI/180);
            const a = Math.sin(dLa/2)*Math.sin(dLa/2) + Math.cos(la1*(Math.PI/180))*Math.cos(la2*(Math.PI/180))*Math.sin(dLo/2)*Math.sin(dLo/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 1.25;
        }

        // --- LÓGICA DE CARRITO ---
        function addItemToCart(id) {
            const p = CATALOG.find(x => x.id == id);
            const it = state_cart.find(x => x.id == id);
            if(it) it.qty++; else state_cart.push({...p, qty: 1});
            updateCart();
            toggleCart(true);
        }

        function updateCart() {
            localStorage.setItem('jst_master_cart', JSON.stringify(state_cart));
            refreshCartUI();
        }

        function refreshCartUI() {
            const list = document.getElementById('cart-items-list');
            const sub = state_cart.reduce((a,b) => a + (b.price*b.qty), 0);
            const count = state_cart.reduce((a,b) => a + b.qty, 0);

            document.getElementById('cart-badge').innerText = count;
            document.getElementById('cart-badge').style.display = count > 0 ? 'flex' : 'none';
            document.getElementById('step1-total').innerText = `S/ ${sub.toFixed(2)}`;

            list.innerHTML = state_cart.map(i => `
                <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                    <img src="${i.img}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
                    <div style="flex:1;"><h4 style="margin:0; font-size:0.9rem;">${i.name}</h4><span>S/ ${i.price.toFixed(2)}</span></div>
                </div>
            `).join('');
            
            refreshSummary();
        }

        function refreshSummary() {
            const sub = state_cart.reduce((a,b) => a + (b.price*b.qty), 0);
            const km = parseFloat(document.getElementById('form-km').value) || 0;
            let ship = (sub < 500 && km > 0) ? Math.max(7, km * 1.90) : 0;
            let total = sub + ship;

            document.getElementById('final-subtotal').innerText = `S/ ${sub.toFixed(2)}`;
            document.getElementById('final-shipping').innerText = sub >= 500 ? "GRATIS" : (ship > 0 ? `S/ ${ship.toFixed(2)}` : "GPS Requerido");
            document.getElementById('final-total').innerText = `S/ ${total.toFixed(2)}`;
            validateForm();
        }

        function validateForm() {
            const n = document.getElementById('form-name').value;
            const p = document.getElementById('form-phone').value;
            const a = document.getElementById('form-address').value;
            const btn = document.getElementById('btn-wa');
            if(n.length > 3 && p.length > 8 && a.length > 5) btn.classList.add('active'); else btn.classList.remove('active');
        }

        function toggleCart(o) { document.getElementById('side-cart').classList.toggle('open', o); }
        function goToStep(s) { document.getElementById('side-cart').className = `side-cart open step-${s}`; }
        
        function launchCelebration() {
            const n = document.getElementById('form-name').value;
            const a = document.getElementById('form-address').value;
            const km = document.getElementById('form-km').value;
            const ship = document.getElementById('final-shipping').innerText;
            const total = document.getElementById('final-total').innerText;

            let msg = `👋 *¡Hola JstoreR! Quiero hacer un pedido*\n\n👤 *Nombre:* ${n}\n📍 *Dirección:* ${a}\n🚚 *Envío:* ${ship} (${km}km)\n💰 *TOTAL:* ${total}\n\n*PRODUCTOS:*\n`;
            state_cart.forEach(i => msg += `- ${i.name} (${i.qty})\n`);

            document.getElementById('celebration-modal').style.display = 'flex';
            setTimeout(() => window.location.href = `https://wa.me/51932508670?text=${encodeURIComponent(msg)}`, 2000);
        }

        function initGoldDust() {
            const cvs = document.getElementById('gold-dust-layer');
            const ctx = cvs.getContext('2d');
            cvs.width = window.innerWidth; cvs.height = window.innerHeight;
            const p = Array(30).fill().map(() => ({ x: Math.random()*cvs.width, y: Math.random()*cvs.height, r: Math.random()*1.5+0.5, s: Math.random()*0.2+0.1 }));
            function d() {
                ctx.clearRect(0,0,cvs.width,cvs.height);
                ctx.fillStyle = "rgba(199, 106, 58, 0.4)";
                p.forEach(f => {
                    ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
                    f.y -= f.s; if(f.y < 0) f.y = cvs.height;
                }); requestAnimationFrame(d);
            } d();
        }
    </script>
</body>
</html>
